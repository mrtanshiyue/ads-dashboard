<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ads Dashboard (Compact Pro v4.1 - Top N 120)</title>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script>
    // åˆå§‹åŒ–ä¸»é¢˜
    (() => {
      const saved = localStorage.getItem("theme");
      if (saved) document.documentElement.setAttribute("data-theme", saved);
    })();
  </script>

  <style>
    /* ================= UI æ ·å¼ ================= */
    :root{
      color-scheme: light; 
      
      --bg:#f5f5f7;
      --card:#ffffff;
      --text:#1d1d1f;
      --muted:#6e6e73;
      --line:#e5e5ea;
      --shadow:0 10px 30px rgba(0,0,0,.06);
      --radius:18px;
      --accent:#0071e3;
      --good:#1a7f37;
      --bad:#b42318;
      --warn:#b54708;
      --chip:#f2f2f7;
      --softGood: rgba(26,127,55,.10);
      --softBad: rgba(180,35,24,.10);
      --softWarn: rgba(181,71,8,.12);
      --input-bg: #ffffff;
      --hover-bg: #fbfbfd;
      --th-bg: #ffffff;
      --chart-grid: rgba(229,229,234,.6);
    }

    /* Dark Mode Variables */
    [data-theme="dark"] {
      color-scheme: dark;

      --bg: #151516;
      --card: #242426;
      --text: #f5f5f7;
      --muted: #a1a1a6;
      --line: #38383a;
      --shadow: 0 10px 30px rgba(0,0,0,.5);
      --accent: #0a84ff;
      --good: #30d158;
      --bad: #ff453a;
      --warn: #ff9f0a;
      --chip: #3a3a3c;
      --softGood: rgba(48, 209, 88, 0.15);
      --softBad: rgba(255, 69, 58, 0.15);
      --softWarn: rgba(255, 159, 10, 0.15);
      --input-bg: #1c1c1e;
      --hover-bg: #323234;
      --th-bg: #242426;
      --chart-grid: rgba(255,255,255,.1);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Display","SF Pro Text","Segoe UI",Roboto,Helvetica,Arial,"PingFang SC","Microsoft YaHei",sans-serif;
      background:var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      font-weight: 500;
      font-size: 12.8px;
      transition: background .3s ease, color .3s ease;
    }
     
    input, select, button, textarea {
      font-weight: 500;
      font-family: inherit;
      font-size: 12.8px;
    }

    .app{
      display:grid;
      grid-template-columns: 360px 1fr;
      min-height:100vh;
      gap:18px;
      padding:18px;
      max-width: 75vw;
      margin: 0 auto;
    }
    .sidebar{
      position:sticky;
      top:18px;
      height:calc(100vh - 36px);
      overflow:auto;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:16px;
      box-shadow:var(--shadow);
      transition: background .3s ease, border-color .3s ease;
    }
    [data-theme="dark"] .sidebar { background: #242426; }

    .content{
      display:flex;
      flex-direction:column;
      gap:14px;
      min-width:0;
    }
    .header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      padding:14px 16px;
      border-radius:var(--radius);
      background:var(--card);
      border:1px solid var(--line);
      box-shadow:var(--shadow);
      transition: background .3s ease, border-color .3s ease;
    }
    .title{ display:flex; flex-direction:column; gap:4px; }
    .title h1{
      margin:0;
      font-size:18.5px;
      letter-spacing:-.2px;
      font-weight:800;
      color: var(--text);
    }
    .title .sub{
      font-size:12.2px;
      color:var(--muted);
      line-height:1.35;
      max-width: 900px;
      font-weight: 500;
    }
    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
    }
    .btn{
      appearance:none;
      border:1px solid var(--line);
      background:var(--card);
      border-radius:999px;
      padding:10px 12px;
      font-size:12.7px;
      cursor:pointer;
      color:var(--text);
      transition:all .2s ease;
      display:inline-flex;
      align-items:center;
      gap:8px;
      box-shadow:0 6px 16px rgba(0,0,0,.06);
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{ background:var(--hover-bg); border-color:var(--muted); }
    .btn:active{ transform:scale(.98); }
     
    .btn.primary{
      border-color:rgba(0,113,227,.25);
      background:rgba(0,113,227,.08);
      color:var(--accent);
    }
    [data-theme="dark"] .btn.primary {
       background: rgba(10, 132, 255, 0.15);
       color: #409cff;
       border-color: rgba(10, 132, 255, 0.3);
    }

    .btn.danger{
      border-color:rgba(180,35,24,.22);
      background:rgba(180,35,24,.08);
      color:var(--bad);
    }
    [data-theme="dark"] .btn.danger {
       background: rgba(255, 69, 58, 0.15);
       color: #ff453a;
       border-color: rgba(255, 69, 58, 0.3);
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:14px;
      min-width:0;
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
      min-width:0;
      transition: background .3s ease, border-color .3s ease;
    }

    .kpi{ grid-column: span 3; user-select:none; }
    .kpi .label{ font-size:12.2px; color:var(--muted); display:flex; justify-content:space-between; align-items:center; gap:10px; font-weight: 500; }
    .kpi .value{ margin-top:6px; font-size:22.5px; font-weight:800; letter-spacing:-.3px; color:var(--text); }
    .kpi .meta{ margin-top:4px; font-size:11.8px; color:var(--muted); display:flex; gap:8px; flex-wrap:wrap; font-weight: 500; }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 8px;
      border-radius:999px;
      background:var(--chip);
      border:1px solid var(--line);
      font-size:11.8px;
      color:var(--muted);
      white-space:nowrap;
      font-weight: 500;
    }

    .chartCard{ grid-column: span 12; }
    .tableCard{ grid-column: span 12; }

    .cardTitle{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:10px;
      margin-bottom:10px;
      flex-wrap:wrap;
    }
    .cardTitle h2{ margin:0; font-size:14.2px; letter-spacing:-.2px; font-weight: 700; color:var(--text); }
    .cardTitle .hint{ font-size:12.2px; color:var(--muted); font-weight: 500; }
    .cardTitle .rightTools{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    .chartWrap{ position:relative; width:100%; height:260px; }
    .chartWrap.tall{ height:320px; }

    .fieldGroup{
      display:flex;
      flex-direction:column;
      gap:10px;
      padding-bottom:12px;
      border-bottom:1px solid var(--line);
      margin-bottom:12px;
    }
    .fieldGroup:last-child{ border-bottom:none; padding-bottom:0; margin-bottom:0; }
    .fieldRow{ display:flex; flex-direction:column; gap:6px; }

    label{ font-size:12.2px; color:var(--muted); font-weight: 500; }
    input[type="text"], input[type="date"], input[type="number"], select{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid var(--line);
      background:var(--input-bg);
      color: var(--text);
      font-size:12.7px;
      outline:none;
      transition:border-color .2s ease, box-shadow .2s ease, background .3s ease;
      appearance:none;
    }
    input[type="text"]:focus, input[type="date"]:focus, input[type="number"]:focus, select:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 4px rgba(0,113,227,.12);
    }
    [data-theme="dark"] input[type="text"]:focus, [data-theme="dark"] input[type="date"]:focus, [data-theme="dark"] select:focus {
        box-shadow: 0 0 0 4px rgba(10,132,255,0.2);
    }

    .selectWrap{ position:relative; }
    .selectWrap:after{
      content:"â–¾";
      position:absolute;
      right:12px;
      top:50%;
      transform:translateY(-50%);
      color:var(--muted);
      pointer-events:none;
      font-size:12.2px;
      font-weight: 700;
    }

    .row2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .row3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }
    .small{ font-size:11.8px; color:var(--muted); line-height:1.35; font-weight: 500; }

    .chips{ display:flex; gap:8px; flex-wrap:wrap; }
    .chipBtn{
      border:1px solid var(--line);
      background:var(--input-bg);
      border-radius:999px;
      padding:8px 10px;
      font-size:12.2px;
      cursor:pointer;
      color: var(--text);
    }
    .chipBtn.active{
      border-color:rgba(0,113,227,.35);
      background:rgba(0,113,227,.08);
      color:var(--accent);
      font-weight: 600;
    }
    [data-theme="dark"] .chipBtn.active {
        background: rgba(10,132,255,0.2);
        color: #409cff;
    }

    .fileList{
      border:1px solid var(--line);
      border-radius:14px;
      background:var(--input-bg);
      padding:10px;
      max-height:180px;
      overflow:auto;
    }

    .table-container{
      overflow:auto;
      max-height:620px;
      border:1px solid var(--line);
      border-radius:14px;
      background:var(--card);
    }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
    }
    thead th{
      position:sticky; top:0;
      background:var(--th-bg);
      border-bottom:1px solid var(--line);
      font-size:12.2px;
      color:var(--muted);
      text-align:left;
      padding:10px 10px;
      white-space:nowrap;
      cursor:pointer;
      user-select:none;
      z-index:2;
      font-weight: 600;
      transition: background .3s ease;
    }
    tbody td{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      font-size:12.8px;
      vertical-align:top;
      font-variant-numeric: tabular-nums; 
      color: var(--text);
    }
    tbody tr:hover{ background:var(--hover-bg); }
    tbody tr:last-child td{ border-bottom:none; }

    .tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      font-size:11.8px;
      white-space:nowrap;
      user-select:none;
      font-weight: 600;
    }
    .tag.good{ color:var(--good); background:var(--softGood); border-color:transparent; }
    .tag.bad{ color:var(--bad); background:var(--softBad); border-color:transparent; }
    .tag.warn{ color:var(--warn); background:var(--softWarn); border-color:transparent; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .seg{
      display:inline-flex;
      border:1px solid var(--line);
      background:var(--input-bg);
      border-radius:999px;
      overflow:hidden;
      box-shadow:0 6px 16px rgba(0,0,0,.06);
    }
    .segBtn{
      border:0;
      background:transparent;
      padding:8px 12px;
      font-size:12.2px;
      cursor:pointer;
      color:var(--muted);
      font-weight: 500;
    }
    .segBtn.active{
      background:rgba(0,113,227,.10);
      color:var(--accent);
      font-weight: 600;
    }
    [data-theme="dark"] .segBtn.active {
        background: rgba(10,132,255,0.2);
    }

    .miniInput{
      width:110px !important;
      padding:8px 10px !important;
      border-radius:999px !important;
      font-size:12.2px !important;
    }
    .miniSelect{
      width:150px !important;
      padding:8px 10px !important;
      border-radius:999px !important;
      font-size:12.2px !important;
    }

    /* å¯¹é½è°ƒæ•´ */
    #autoManualTable th:last-child, 
    #autoManualTable td:last-child,
    #longTailTable th:last-child,
    #longTailTable td:last-child,
    #weekdayTable th:last-child,
    #weekdayTable td:last-child,
    #cpcDistTable th:last-child,
    #cpcDistTable td:last-child,
    #lengthTable th:last-child,
    #lengthTable td:last-child,
    #matchTypeTable th:last-child,
    #matchTypeTable td:last-child,
    #conflictTable th:last-child,
    #conflictTable td:last-child {
      text-align: left; 
    }
    .bar-row {
        display: flex; 
        align-items: center; 
        justify-content: flex-start; 
        gap: 8px; 
        font-size: 11.5px;
        width: 100%;
        max-width: 200px;
    }
    .bar-track {
        flex: 1;
        height: 6px; 
        background: var(--line); 
        border-radius: 3px; 
        overflow: hidden; 
        display: flex;
    }
    .pareto-box {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .pareto-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: var(--hover-bg);
      border: 1px solid var(--line);
      border-radius: 12px;
    }
    .pareto-left { display: flex; flex-direction: column; gap: 4px; }
    .pareto-right { font-weight: 800; font-size: 16px; color: var(--text); }
    .pareto-desc { font-size: 11.5px; color: var(--muted); }

    @media (max-width: 1400px){
      .app{ max-width: 100vw; }
    }
    @media (max-width: 1100px){
      .app{ grid-template-columns:1fr; max-width:100vw; }
      .sidebar{ position:relative; height:auto; }
      .kpi{ grid-column: span 6; }
      .chartCard{ grid-column: span 12; }
    }
    @media (max-width: 650px){
      .kpi{ grid-column: span 12; }
      .actions{ justify-content:flex-start; }
      .row3{ grid-template-columns:1fr; }
      .miniInput, .miniSelect{ width:100% !important; border-radius:12px !important; }
      .pareto-item { flex-direction: column; align-items: flex-start; gap: 8px; }
    }
  </style>
</head>

<body>
<div class="app">
  <aside class="sidebar">
    <div class="fieldGroup">
      <div class="fieldRow">
        <label>å¯¼å…¥åŒç±»æŠ¥è¡¨ï¼ˆå¤šæ–‡ä»¶ CSV / XLSXï¼‰</label>
        <input id="fileInput" type="file" accept=".csv,.xlsx,.xls" multiple />
        <div class="small">é»˜è®¤è¿½åŠ åˆå¹¶ï¼›é»˜è®¤å¼€å¯å»é‡ï¼›å¯¼å…¥è¿‡ç¨‹/é”™è¯¯è¯·çœ‹â€œå¯¼å…¥æ—¥å¿—â€</div>
      </div>

      <div class="row2">
        <div class="fieldRow">
          <label>åˆå¹¶æ¨¡å¼</label>
          <div class="selectWrap">
            <select id="mergeMode">
              <option value="append" selected>è¿½åŠ åˆå¹¶ï¼ˆAppendï¼‰</option>
              <option value="replace">æ›¿æ¢ï¼ˆReplaceï¼‰</option>
            </select>
          </div>
        </div>
        <div class="fieldRow">
          <label>å»é‡</label>
          <div class="selectWrap">
            <select id="dedupeMode">
              <option value="on" selected>å¼€å¯ï¼ˆæ¨èï¼‰</option>
              <option value="off">å…³é—­</option>
            </select>
          </div>
        </div>
      </div>

      <div class="fieldRow">
        <label>å·²å¯¼å…¥æ–‡ä»¶</label>
        <div id="fileList" class="fileList"><div class="small">æš‚æ— </div></div>
      </div>

      <div class="row2">
        <div class="fieldRow">
          <label>æ—¥æœŸå¼€å§‹</label>
          <input id="dateStart" type="date" />
        </div>
        <div class="fieldRow">
          <label>æ—¥æœŸç»“æŸ</label>
          <input id="dateEnd" type="date" />
        </div>
      </div>

      <div class="chips">
        <button class="chipBtn" data-range="yesterday" type="button">æ˜¨å¤©</button>
        <button class="chipBtn" data-range="7d" type="button">è¿‘7å¤©</button>
        <button class="chipBtn" data-range="30d" type="button">è¿‘30å¤©</button>
        <button class="chipBtn" data-range="mtd" type="button">æœ¬æœˆ</button>
        <button class="chipBtn" data-range="all" type="button">å…¨éƒ¨</button>
      </div>
    </div>

    <div class="fieldGroup">
      <div class="fieldRow">
        <label>æ¥æºæ–‡ä»¶ï¼ˆSource Fileï¼‰</label>
        <div class="selectWrap"><select id="filterSource"></select></div>
      </div>

      <div class="fieldRow">
        <label>å¹¿å‘Šç»„åˆï¼ˆPortfolioï¼‰</label>
        <div class="selectWrap"><select id="filterPortfolio"></select></div>
      </div>
      <div class="fieldRow">
        <label>å¹¿å‘Šæ´»åŠ¨ï¼ˆCampaignï¼‰</label>
        <div class="selectWrap"><select id="filterCampaign"></select></div>
      </div>
      <div class="fieldRow">
        <label>å¹¿å‘Šç»„ï¼ˆAd Groupï¼‰</label>
        <div class="selectWrap"><select id="filterAdGroup"></select></div>
      </div>
      <div class="fieldRow">
        <label>æŠ•æ”¾ï¼ˆTargetingï¼‰</label>
        <div class="selectWrap"><select id="filterTargeting"></select></div>
      </div>
      <div class="fieldRow">
        <label>åŒ¹é…ç±»å‹ï¼ˆMatch Typeï¼‰</label>
        <div class="selectWrap"><select id="filterMatchType"></select></div>
      </div>

      <div class="fieldRow">
        <label>å¹¿å‘Šç±»å‹ (Ad Type)</label>
        <div class="selectWrap">
            <select id="filterAdType">
                <option value="" selected>å…¨éƒ¨ (All)</option>
                <option value="manual">æ‰‹åŠ¨å¹¿å‘Š (Manual)</option>
                <option value="auto">è‡ªåŠ¨å¹¿å‘Š (Auto)</option>
            </select>
        </div>
      </div>

      <div class="fieldRow">
        <label>å®¢æˆ·æœç´¢è¯ï¼ˆSearch Termï¼‰</label>
        <input id="filterSearchTerm" type="text" placeholder="ä¾‹å¦‚: blue light / magnification / women / cat eye / b07ybhgt31" />
        <div style="display:flex; align-items:center; gap:6px; margin-top:6px; padding-left:2px;">
           <input type="checkbox" id="filterSearchExact" style="width:14px; height:14px; appearance:auto; -webkit-appearance:checkbox; margin:0; cursor:pointer">
           <label for="filterSearchExact" style="margin:0; cursor:pointer; font-size:12px; color:var(--text);">ç²¾å‡†æœç´¢ (Exact Match)</label>
        </div>
      </div>
      <div class="small">ç­›é€‰æ”¹åŠ¨å°†è‡ªåŠ¨ç”Ÿæ•ˆï¼ˆæ— éœ€ç‚¹å‡»åº”ç”¨ï¼‰</div>
    </div>

    <div class="fieldGroup">
      <div class="fieldRow">
        <label>æ¦œå•èšåˆç»´åº¦</label>
        <div class="selectWrap">
          <select id="rankBy">
            <option value="searchTerm" selected>å®¢æˆ·æœç´¢è¯ï¼ˆSearch Termï¼‰</option>
            <option value="searchTermRoot">Search Term Rootï¼ˆè¯æ ¹èšç±»ï¼‰</option>
            <option value="targeting">æŠ•æ”¾ï¼ˆTargetingï¼‰</option>
            <option value="campaign">å¹¿å‘Šæ´»åŠ¨ï¼ˆCampaignï¼‰</option>
            <option value="adGroup">å¹¿å‘Šç»„ï¼ˆAd Groupï¼‰</option>
          </select>
        </div>
        <div class="small">
          Root è§„åˆ™ï¼šå»åœç”¨è¯ + åŒä¹‰è¯å½’ä¸€ + ä¿ç•™å€ç‡ï¼ˆå¦‚ 2.0ï¼‰+ åˆå¹¶çŸ­è¯­ï¼ˆblue light / cat eye / spring hingeï¼‰
        </div>
      </div>

      <div class="row2">
        <div class="fieldRow">
          <label>Top N</label>
          <input id="rankTopN" type="number" step="1" value="120" />
        </div>
        <div class="fieldRow">
          <label>æœ€å¤§å¯¼å…¥è¡Œæ•°ï¼ˆé˜²å¡æ­»ï¼‰</label>
          <input id="maxRows" type="number" step="1000" value="250000" />
        </div>
      </div>
    </div>

    <div class="fieldGroup">
      <div class="fieldRow">
        <label>è‡ªåŠ¨åˆ¤å®šè§„åˆ™ï¼ˆå¯è°ƒï¼‰</label>
        <div class="small">åœ¨â€œæ¦œå•â€å±‚é¢æ‰“æ ‡ï¼šNEGATE / MIGRATE / KEEPï¼Œå¹¶ç»™å‡ºç†ç”±ï¼›å¯¼å‡ºä»…å¯¼å‡º NEGATE</div>
      </div>

      <div class="row3">
        <div class="fieldRow">
          <label>å¦å®šèŠ±è´¹ â‰¥</label>
          <input id="ruleSpendNeg" type="number" step="0.01" value="30" />
        </div>
        <div class="fieldRow">
          <label>å¦å®šç‚¹å‡»é‡ â‰¥</label>
          <input id="ruleClicksNeg" type="number" step="1" value="20" />
        </div>
        <div class="fieldRow">
          <label>å¦å®š ROAS &lt;</label>
          <input id="ruleRoasNeg" type="number" step="0.1" value="1.5" />
        </div>
      </div>

      <div class="row3">
        <div class="fieldRow">
          <label>ä¿ç•™ ROAS â‰¥</label>
          <input id="ruleRoasKeep" type="number" step="0.1" value="3" />
        </div>
        <div class="fieldRow">
          <label>ä¿ç•™è®¢å•æ•° â‰¥</label>
          <input id="ruleOrdersKeep" type="number" step="1" value="2" />
        </div>
        <div class="fieldRow">
          <label>è¿ç§» ROAS â‰¥</label>
          <input id="ruleRoasMigrateMin" type="number" step="0.1" value="2" />
        </div>
      </div>

      <div class="row2">
        <div class="fieldRow">
          <label>å¯¼å‡ºèŒƒå›´</label>
          <div class="selectWrap">
            <select id="exportScope">
              <option value="rank" selected>å½“å‰æ¦œå•ï¼ˆTop Nï¼‰</option>
              <option value="view">å½“å‰è§†å›¾ï¼ˆå…¨éƒ¨åˆ†ç»„ï¼‰</option>
            </select>
          </div>
        </div>
        <div class="fieldRow">
          <label>å¦å®šåŒ¹é…ç±»å‹</label>
          <div class="selectWrap">
            <select id="exportNegMatch">
              <option value="phrase" selected>PHRASEï¼ˆæ¨èï¼‰</option>
              <option value="exact">EXACTï¼ˆæ›´ç²¾å‡†ï¼‰</option>
            </select>
          </div>
        </div>
      </div>

      <div class="row2">
        <button class="btn primary" id="btnExportNeg" type="button">å¯¼å‡ºå¦å®šè¯ CSVï¼ˆä»… NEGATEï¼‰</button>
        <button class="btn" id="btnRuleReset" type="button">é‡ç½®é»˜è®¤è§„åˆ™</button>
      </div>

      <div class="small">
        å¯¼å‡ºé™åˆ¶ï¼šåªæœ‰æ¦œå•ç»´åº¦ä¸º Search Term / Root æ—¶å…è®¸å¯¼å‡ºï¼ˆé¿å…å¯¼å‡º Campaign/AdGroup ä¹‹ç±»çš„åå­—å½“å¦å®šè¯ï¼‰
      </div>
    </div>

    <div class="fieldGroup">
      <div class="fieldRow">
        <label>æ“ä½œ</label>
      </div>
      <div class="fieldRow"><button class="btn" id="btnReset" type="button">é‡ç½®ç­›é€‰</button></div>
      <div class="fieldRow"><button class="btn danger" id="btnClearAll" type="button">æ¸…ç©ºå·²å¯¼å…¥æ•°æ®</button></div>
    </div>

    <div class="fieldGroup">
      <div class="fieldRow">
        <label>å¯¼å…¥æ—¥å¿—</label>
        <div id="logBox" class="fileList" style="max-height:220px"><div class="small">æš‚æ— </div></div>
      </div>
    </div>

  </aside>

  <main class="content">
    <section class="header">
      <div class="title">
        <h1>æœ—å®¹çœ¼é•œæœ‰é™å…¬å¸ Ads Performance Dashboard</h1>
        <div class="sub" id="subtitle">æœªå¯¼å…¥æ•°æ®ã€‚è¯·å¯¼å…¥åŒç±»æŠ¥è¡¨ï¼ˆæ”¯æŒå¤šæ–‡ä»¶ï¼‰ã€‚</div>
      </div>
      <div class="actions">
        <button class="btn" id="btnTheme" type="button">ğŸŒ— æ·±è‰²/æµ…è‰²</button>
        <button class="btn" id="btnCheck" type="button">ä¾èµ–è‡ªæ£€</button>
        <button class="btn" id="btnDemo" type="button">è½½å…¥æ¼”ç¤ºæ•°æ®ï¼ˆä¸¤æ–‡ä»¶åˆå¹¶ï¼‰</button>
      </div>
    </section>

    <section class="grid" id="kpiGrid"></section>

    <section class="grid">
      
      <div class="card chartCard">
        <div class="cardTitle">
          <h2>æ¯æ—¥è¶‹åŠ¿</h2>
          <div class="hint">èŠ±è´¹ / é”€å”®é¢ / è®¢å•æ•° / ACOS / ROAS</div>
        </div>
        <div class="chartWrap tall"><canvas id="trendChart"></canvas></div>
      </div>

      <div class="card tableCard">
        <div class="cardTitle">
          <h2>å‘¨ç»´åº¦åˆ†æ (Weekday Performance)</h2>
          <div class="hint">å‘ç°ä¸€å‘¨ä¸­çš„æœ€ä½³é”€å”®æ—¥/äºæŸæ—¥ (Mon-Sun)</div>
        </div>
        <div class="table-container">
          <table id="weekdayTable">
            <thead>
              <tr>
                <th>æ˜ŸæœŸ</th>
                <th style="width:200px;">é”€å”®é¢çƒ­åº¦</th>
                <th>èŠ±è´¹</th>
                <th>é”€å”®é¢</th>
                <th>è®¢å•æ•°</th>
                <th>ROAS</th>
                <th>ACOS</th>
                <th>CPC</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="card tableCard" id="autoManualCard">
        <div class="cardTitle">
          <h2>è‡ªåŠ¨/æ‰‹åŠ¨å¹¿å‘Šå¯¹æ¯”</h2>
          <div class="hint">æ‰‹åŠ¨: Broad/Phrase/Exact; è‡ªåŠ¨: å…¶ä»–</div>
        </div>
        <div class="table-container">
          <table id="autoManualTable">
            <thead>
              <tr>
                <th>æŒ‡æ ‡</th>
                <th>è‡ªåŠ¨ (Auto)</th>
                <th>æ‰‹åŠ¨ (Manual)</th>
                <th>å æ¯” (Auto / Manual)</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="card tableCard" id="matchTypeCard">
        <div class="cardTitle">
          <h2>åŒ¹é…ç±»å‹é€è§† (Match Type Deep Dive)</h2>
          <div class="hint">Exact / Phrase / Broad / Auto æ•ˆèƒ½å¯¹æ¯”</div>
        </div>
        <div class="table-container">
          <table id="matchTypeTable">
            <thead>
              <tr>
                <th>åŒ¹é…ç±»å‹</th>
                <th style="width:200px;">èŠ±è´¹å æ¯”</th>
                <th>èŠ±è´¹</th>
                <th>é”€å”®é¢</th>
                <th>è®¢å•æ•°</th>
                <th>ROAS</th>
                <th>ACOS</th>
                <th>CPC</th>
                <th>CVR</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="card tableCard" id="lengthCard">
        <div class="cardTitle">
          <h2>è¯é•¿æ•ˆèƒ½åˆ†æ (Keyword Length Analysis)</h2>
          <div class="hint">çŸ­å°¾(æ³›) vs é•¿å°¾(å‡†) | åˆ†æå•è¯æ•°é‡å¯¹ ROAS çš„å½±å“</div>
        </div>
        <div class="table-container">
          <table id="lengthTable">
            <thead>
              <tr>
                <th>å•è¯æ•°</th>
                <th style="width:200px;">èŠ±è´¹å æ¯”</th>
                <th>èŠ±è´¹</th>
                <th>é”€å”®é¢</th>
                <th>è®¢å•æ•°</th>
                <th>ROAS</th>
                <th>ACOS</th>
                <th>CVR</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="small" style="margin-top:10px;">
           æ´å¯Ÿï¼šé€šå¸¸ 3-5 ä¸ªè¯çš„â€œä¸­é•¿å°¾â€è½¬åŒ–ç‡æ›´é«˜ã€‚å¦‚æœ 1-2 ä¸ªè¯èŠ±è´¹å·¨å¤§ä¸” ROAS ä½ï¼Œè€ƒè™‘å°†å…¶è®¾ä¸ºç²¾ç¡®åŒ¹é…æˆ–å¦å®šã€‚
        </div>
      </div>

      <div class="card tableCard">
        <div class="cardTitle">
          <h2>CPC åŒºé—´æ•ˆèƒ½åˆ†æ (CPC Distribution)</h2>
          <div class="hint">å‘ç° ROAS æœ€é«˜çš„â€œç”œç‚¹â€å‡ºä»·åŒºé—´ (Sweet Spot)</div>
        </div>
        <div class="table-container">
          <table id="cpcDistTable">
            <thead>
              <tr>
                <th>CPC åŒºé—´</th>
                <th style="width:200px;">é”€å”®é¢å æ¯”</th>
                <th>èŠ±è´¹</th>
                <th>é”€å”®é¢</th>
                <th>è®¢å•æ•°</th>
                <th>ROAS</th>
                <th>ACOS</th>
                <th>CVR</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="small" style="margin-top:10px;">
          è¯´æ˜ï¼šæ ¹æ®æ¯ä¸ªè¯çš„å®é™…å¹³å‡ CPC å½’ç±»ã€‚1.00-2.00 åŒºé—´å·²æŒ‰ 0.1 ç»†åˆ†ï¼ŒåŠ©ä½ ç²¾å‡†å®šä½æœ€ä½³å‡ºä»·ã€‚
        </div>
      </div>

      <div class="card tableCard">
        <div class="cardTitle">
          <h2>æ¦œå•</h2>
          <div class="rightTools">
            <div class="seg" role="tablist" aria-label="Type Filter">
              <button id="btnTypeAll" class="segBtn active" data-type="all" type="button">å…¨éƒ¨</button>
              <button id="btnTypeKw" class="segBtn" data-type="keyword" type="button">å…³é”®è¯</button>
              <button id="btnTypeAsin" class="segBtn" data-type="asin" type="button">ASIN</button>
            </div>

            <button class="btn primary" id="btnExportRank" type="button" style="padding: 6px 12px; font-size:11.8px;">å¯¼å‡ºæ¦œå• CSV</button>

            <span class="tag bad">å¦å®š</span>
            <span class="tag warn">è¿ç§»</span>
            <span class="tag good">ä¿ç•™</span>
            <span class="hint">ç‚¹å‡»è¡¨å¤´æ’åº</span>
          </div>
        </div>

        <div class="table-container">
          <table id="rankTable">
            <thead>
              <tr>
                <th data-sort="name">åç§°</th>
                <th data-sort="spend">èŠ±è´¹</th>
                <th data-sort="sales">é”€å”®é¢</th>
                <th data-sort="orders">è®¢å•æ•°</th>
                <th data-sort="impr">å±•ç¤ºé‡</th>
                <th data-sort="clicks">ç‚¹å‡»é‡</th>
                <th data-sort="ctr">ç‚¹å‡»ç‡</th>
                <th data-sort="cpc">ç‚¹å‡»æˆæœ¬</th>
                <th data-sort="cvr">è½¬åŒ–ç‡</th>
                <th data-sort="acos">ACOS</th>
                <th data-sort="roas">ROAS</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="small" style="margin-top:10px;">
          å£å¾„ï¼šACOS=èŠ±è´¹/é”€å”®é¢ï¼›ROAS=é”€å”®é¢/èŠ±è´¹ï¼›CTR=ç‚¹å‡»é‡/å±•ç¤ºé‡ï¼›CVR=è®¢å•æ•°/ç‚¹å‡»é‡
        </div>
      </div>

      <div class="card tableCard" id="longTailCard">
        <div class="cardTitle">
          <h2>é•¿å°¾è¯æŒ–æ˜ (Long-Tail Keyword Mining)</h2>
          <div class="rightTools">
             <span class="pill">å•è¯æ•° â‰¥</span>
             <input id="ltMinWords" class="miniInput" type="number" step="1" value="3" title="Search Term åŒ…å«çš„å•è¯æ•°" />
             <span class="pill">è®¢å• â‰¥</span>
             <input id="ltMinOrders" class="miniInput" type="number" step="1" value="2" title="è‡³å°‘äº§ç”Ÿè®¢å•æ•°" />
             <span class="pill">ROAS â‰¥</span>
             <input id="ltMinRoas" class="miniInput" type="number" step="0.1" value="2.0" title="ROAS é—¨æ§›" />
             <button class="btn primary" id="btnExportLongTail" type="button">å¯¼å‡ºé•¿å°¾è¯ CSV</button>
          </div>
        </div>
        <div class="table-container" style="max-height:480px;">
          <table id="longTailTable">
            <thead>
              <tr>
                <th>æœç´¢è¯ (Search Term)</th>
                <th>å•è¯æ•°</th>
                <th>èŠ±è´¹</th>
                <th>é”€å”®é¢</th>
                <th>è®¢å•æ•°</th>
                <th>ROAS</th>
                <th>ACOS</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="small" style="margin-top:10px;">
          é€»è¾‘ï¼šç­›é€‰å‡ºé ASINã€å•è¯æ•°è¾¾æ ‡ã€ä¸”æœ‰å‡ºå•è®°å½•çš„ç²¾å‡†é•¿å°¾è¯ã€‚å»ºè®®å°†é«˜ ROAS çš„é•¿å°¾è¯æŠ•æ”¾ Exact (ç²¾å‡†åŒ¹é…)ã€‚
        </div>
      </div>

      <div class="card tableCard">
        <div class="cardTitle">
          <h2>è¯é¢‘åˆ†æï¼ˆWord Frequency Analysisï¼‰</h2>
          <div class="rightTools">
            <div class="seg" role="tablist" aria-label="Word Frequency Mode">
              <button class="segBtn active" data-wf="token" type="button">Token</button>
              <button class="segBtn" data-wf="bigram" type="button">2-gram</button>
              <button class="segBtn" data-wf="trigram" type="button">3-gram</button>
              <button class="segBtn" data-wf="mag" type="button">å€ç‡</button>
            </div>
            <span class="pill">Min Freq</span>
            <input id="wfMinFreq" class="miniInput" type="number" step="1" value="3" title="æœ€å°å‡ºç°æ¬¡æ•°" />
            <span class="pill">Min Spend</span>
            <input id="wfMinSpend" class="miniInput" type="number" step="0.01" value="10" title="æœ€å°èŠ±è´¹" />
            <span class="hint">ç‚¹å‡»è¡¨å¤´æ’åºï¼Œç‚¹å‡»è¯æ¡æœç´¢</span>
          </div>
        </div>

        <div class="table-container" style="max-height:480px;">
          <table id="wfTable">
            <thead>
              <tr>
                <th data-sort="word">è¯</th>
                <th data-sort="freq">é¢‘æ¬¡</th>
                <th data-sort="spend">èŠ±è´¹</th>
                <th data-sort="orders">è®¢å•</th>
                <th data-sort="roas">ROAS</th>
                <th data-sort="acos">ACOS</th>
                <th data-sort="action">åŠ¨ä½œ</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="small" style="margin-top:10px;">
          å»ºè®®ï¼š2-gram æ›´è´´è¿‘â€œæ„å›¾çŸ­è¯­â€ï¼Œæ›´é€‚åˆåšå¦è¯æ ¹/è¿ç§» Exactï¼›å€ç‡ç”¨äºåˆ¤æ–­ 1.5/2.0/2.5 å“ªä¸ªæ›´èµšé’±
        </div>
      </div>

      <div class="card tableCard" id="conflictCard">
        <div class="cardTitle">
          <h2>å†…éƒ¨ç«äº‰/å…³é”®è¯å†²çªæ£€æµ‹ (Conflict & Cannibalization)</h2>
          <div class="hint">åŒä¸€ Search Term å‡ºç°äºå¤šä¸ªå¹¿å‘Šç»„ï¼ˆæƒé‡åˆ†æ•£ï¼‰</div>
          <div class="rightTools">
             <span class="pill" style="background:var(--softWarn); color:var(--warn); border-color:transparent">å»ºè®®ï¼šç‚¹å‡»å†²çªè¯ â†’ ç­›é€‰ â†’ å…³æ‰è¡¨ç°å·®çš„ç»„</span>
          </div>
        </div>
        <div class="table-container" style="max-height:480px;">
          <table id="conflictTable">
            <thead>
              <tr>
                <th>æœç´¢è¯ (Search Term)</th>
                <th>å†²çªä½ç½®æ•° (Count)</th>
                <th style="width:300px;">æ¶‰åŠå¹¿å‘Šç»„ (Locations)</th>
                <th>æ€»èŠ±è´¹</th>
                <th>æ€»è®¢å•</th>
                <th>ROAS</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="small" style="margin-top:10px;">
          åŸç†ï¼šåˆ—å‡ºåœ¨ 2 ä¸ªæˆ–ä»¥ä¸Šä¸åŒå¹¿å‘Šç»„ï¼ˆCampaign+AdGroupï¼‰ä¸­æ¶ˆè€—é¢„ç®—çš„è¯ã€‚å¦‚æœè¯¥è¯åœ¨å¤šä¸ªç»„è¡¨ç°å·®å¼‚å·¨å¤§ï¼Œå»ºè®®å°†é¢„ç®—é›†ä¸­åˆ°è¡¨ç°æœ€å¥½çš„ç»„ï¼Œå¦å®šå·®çš„ç»„ã€‚
        </div>
      </div>

      <div class="card tableCard">
        <div class="cardTitle">
          <h2>åŠ ä»·è¯ & å¦å®šè¯æ¸…å•ï¼ˆåŒºåˆ† Keyword / ASINï¼‰</h2>
          <div class="rightTools">
            <div class="seg" role="tablist" aria-label="Action Type Filter">
              <button class="segBtn active" id="btnActAll" data-act="all" type="button">å…¨éƒ¨</button>
              <button class="segBtn" id="btnActKw" data-act="keyword" type="button">å…³é”®è¯</button>
              <button class="segBtn" id="btnActAsin" data-act="asin" type="button">ASIN</button>
            </div>

            <span class="pill">åŠ ä»·</span>
            <input id="bidSpend" class="miniInput" type="number" step="0.01" value="20" title="BID UP Spend â‰¥" />
            <input id="bidOrders" class="miniInput" type="number" step="1" value="2" title="BID UP Orders â‰¥" />
            <input id="bidRoas" class="miniInput" type="number" step="0.1" value="3.5" title="BID UP ROAS â‰¥" />
            <select id="bidIntensity" class="miniSelect" title="åŠ ä»·å»ºè®®å¼ºåº¦">
              <option value="auto" selected>è‡ªåŠ¨ (ROAS åˆ†å±‚)</option>
              <option value="10">ç»Ÿä¸€ +10%</option>
              <option value="20">ç»Ÿä¸€ +20%</option>
              <option value="30">ç»Ÿä¸€ +30%</option>
            </select>
            <button class="btn primary" id="btnExportBidUp" type="button">å¯¼å‡ºåŠ ä»·è¯ CSV</button>
          </div>
        </div>

        <div class="grid" style="grid-template-columns: repeat(12, 1fr); gap:14px;">
          <div class="card" style="grid-column: span 6;">
            <div class="cardTitle" style="margin-bottom:8px;">
              <h2>åŠ ä»·è¯ï¼ˆBID UPï¼‰</h2>
              <div class="hint">æ»¡è¶³ èŠ±è´¹/è®¢å•æ•°/ROAS é˜ˆå€¼æ‰å…¥é€‰ï¼ˆéšç­›é€‰è‡ªåŠ¨åˆ·æ–°ï¼‰</div>
            </div>
            <div class="table-container" style="max-height: 420px;">
              <table id="bidUpTable">
                <thead>
                  <tr>
                    <th>ç±»å‹</th>
                    <th>åç§°</th>
                    <th>èŠ±è´¹</th>
                    <th>è®¢å•æ•°</th>
                    <th>ROAS</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div class="small" style="margin-top:10px;">
              å»ºè®®ç”¨é€”ï¼šåŠ ä»· / æé¢„ç®— / è¿ç§»åˆ°ç²¾ç¡®ï¼ˆæˆ–å•ç‹¬å¹¿å‘Šç»„ï¼‰
            </div>
          </div>

          <div class="card" style="grid-column: span 6;">
            <div class="cardTitle" style="margin-bottom:8px;">
              <h2>å¦å®šè¯ï¼ˆNEGATEï¼‰</h2>
              <div class="hint">ä»…å½“ç»´åº¦ä¸º æœç´¢è¯ / è¯æ ¹ æ—¶ç”Ÿæˆå¦å®šå»ºè®®</div>
            </div>
            <div class="table-container" style="max-height: 420px;">
              <table id="negListTable">
                <thead>
                  <tr>
                    <th>ç±»å‹</th>
                    <th>åç§°</th>
                    <th>èŠ±è´¹</th>
                    <th>è®¢å•æ•°</th>
                    <th>ROAS</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div class="small" style="margin-top:10px;">
              æé†’ï¼šå¯¼å‡ºå¦å®šè¯ä»ä»¥å·¦ä¾§â€œå¯¼å‡ºå¦å®šè¯ CSVï¼ˆä»… NEGATEï¼‰â€ä¸ºå‡†
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>
</div>

<script>
/** =========================
 * Utils
 * ========================= */
const $ = (id) => document.getElementById(id);
const fmtMoney = (v) => isFinite(v) ? new Intl.NumberFormat("en-US",{maximumFractionDigits:2}).format(v) : "0";
const fmtInt = (v) => new Intl.NumberFormat("en-US",{maximumFractionDigits:0}).format(v||0);
const fmtPct = (v) => (isFinite(v) ? (v*100).toFixed(2)+"%" : "0.00%");

// Robust number parsing
const safeNum = (x) => {
  if (typeof x === "number") return isFinite(x) ? x : 0;
  const s = String(x ?? "").trim();
  if (!s) return 0;
  const isPercent = s.includes("%");
  const n = Number(s.replace(/[^0-9.\-]/g, ""));
  if (isFinite(n)) return isPercent ? n / 100 : n;
  return 0;
};

// [ä¿®å¤] æ—¥æœŸè§£æé€»è¾‘ (Fix Timezone Shifting Bug)
// ä¹‹å‰ä½¿ç”¨ new Date(string) ä¼šå¯¼è‡´ "2023-10-01" åœ¨æŸäº›æ—¶åŒº(å¦‚ç¾å›½)å˜æˆ "2023-09-30"
const toISODate = (d) => {
  if (typeof d === "number" && isFinite(d)) {
    // Excel Serial Date (1900 bug handled by assuming standard logic is fine for ad data)
    // -25569 is offset for 1970-01-01
    const dt = new Date(Math.round((d - 25569) * 86400 * 1000));
    return isNaN(dt) ? "" : dt.toISOString().slice(0,10);
  }
  const s = String(d || "").trim();
  if (!s) return "";
  
  // å°è¯•åŒ¹é… YYYY-MM-DD æˆ– YYYY/MM/DD æˆ– YYYY.MM.DD
  const matchISO = s.match(/^(\d{4})[-\/.](\d{1,2})[-\/.](\d{1,2})/);
  if (matchISO) {
    const y = matchISO[1];
    const m = matchISO[2].padStart(2, "0");
    const d = matchISO[3].padStart(2, "0");
    return `${y}-${m}-${d}`;
  }

  // Fallback for M/D/YY or other formats
  const dt = new Date(s);
  if (isNaN(dt.getTime())) return "";
  return dt.toISOString().slice(0,10); 
};

// [æ–°å¢] ç”Ÿæˆç®€å•æ—¶é—´æˆ³å­—ç¬¦ä¸² (ç”¨äºæ–‡ä»¶åå»é‡)
const getTs = () => {
  const now = new Date();
  const YYYY = now.getFullYear();
  const MM = String(now.getMonth() + 1).padStart(2, '0');
  const DD = String(now.getDate()).padStart(2, '0');
  const HH = String(now.getHours()).padStart(2, '0');
  const mm = String(now.getMinutes()).padStart(2, '0');
  const ss = String(now.getSeconds()).padStart(2, '0');
  return `${YYYY}${MM}${DD}_${HH}${mm}${ss}`;
};

const escapeHtml = (s) => String(s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'})[c]);
const clamp = (v,min,max)=>Math.max(min, Math.min(max, v));
const setSubtitle = (text)=>$("subtitle").textContent = text;
const debounce = (fn, wait=250)=>{let t; return (...args)=>{clearTimeout(t); t=setTimeout(()=>fn(...args),wait);};};

const logBox = $("logBox");
const clearLog = ()=>logBox.innerHTML = "";
const log = (msg, level="info")=>{
  const t = new Date(), stamp = `${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}:${String(t.getSeconds()).padStart(2,"0")}`;
  const line = document.createElement("div");
  line.className = "small"; line.style.cssText = "padding:6px 6px;border-bottom:1px solid rgba(229,229,234,.7);";
  if (level==="bad") line.style.color = "#b42318";
  if (level==="warn") line.style.color = "#b54708";
  if (level==="good") line.style.color = "#1a7f37";
  line.textContent = `[${stamp}] ${msg}`;
  logBox.prepend(line);
};

const libsCheck = () => {
  const missing = [];
  if (typeof Papa === "undefined") missing.push("PapaParse(Papa)");
  if (typeof XLSX === "undefined") missing.push("XLSX(xlsx)");
  if (typeof Chart === "undefined") missing.push("Chart.js(Chart)");
  if (missing.length) log("ä¾èµ–åº“æœªåŠ è½½ï¼š" + missing.join(", ") + "ã€‚åŸå› å¤šä¸ºç½‘ç»œé™åˆ¶ / CDN è¢«æ‹¦ã€‚è§£å†³æ–¹æ¡ˆï¼šæ¢ç½‘ç»œï¼Œæˆ–æ”¹ä¸ºæœ¬åœ°å¼•å…¥ 3 ä¸ª JS æ–‡ä»¶ã€‚", "bad");
  else log("ä¾èµ–åº“ OKï¼ˆPapaParse / XLSX / Chart.jsï¼‰", "good");
  return !missing.length;
};

// [ä¿®å¤] CSV æ³¨å…¥é˜²å¾¡ (Formula Injection Protection)
const toCSV = (rows) => rows.map(r => r.map(v => {
  let s = String(v ?? "");
  // å¦‚æœé¦–å­—ç¬¦æ˜¯ = + - @ï¼Œåœ¨å‰é¢åŠ å•å¼•å·ï¼Œé˜²æ­¢ Excel è‡ªåŠ¨æ‰§è¡Œ
  if (/^[=+\-@]/.test(s)) {
      s = "'" + s;
  }
  return /[",\n]/.test(s) ? `"${s.replaceAll('"','""')}"` : s;
}).join(",")).join("\n");

const downloadText = (filename, text) => {
  const blob = new Blob(["\uFEFF"+text], {type:"text/plain;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(a.href);
};

/** =========================
 * Root Mining
 * ========================= */
const STOP_WORDS = new Set("a,an,the,and,or,to,for,of,in,on,at,with,without,from,by,is,are,was,were,your,my,our,their,his,her,its,this,that,these,those,you,me,we,they,pack,set,pairs,pair,pcs,piece,pieces,new,best,top,sale,deal,gift,men,man,male,women,woman,female,unisex,adult,adults,kids,kid,glasses,glass,eyeglasses,eyewear".split(','));
const SYNONYM_MAP = [
  { re: /\breaders?\b/g, to: "reading glasses" }, { re: /\bmagnification\b/g, to: "magnify" },
  { re: /\bmagnifying\b/g, to: "magnify" }, { re: /\bblue\-?light\b/g, to: "blue light" },
  { re: /\banti\-?blue\b/g, to: "blue light" }, { re: /\bcomputer\b/g, to: "screen" },
  { re: /\blaptop\b/g, to: "screen" }, { re: /\bpc\b/g, to: "screen" },
  { re: /\bspring\-?hinge\b/g, to: "spring hinge" }, { re: /\bcat\-?eye\b/g, to: "cat eye" },
  { re: /\bprogressive\b/g, to: "progressive" }
];
const PHRASES = ["blue light", "cat eye", "spring hinge", "anti glare", "scratch resistant"];
const MAG_RE = /\b([1-3](?:\.\d{1,2})?)\b/g;

const PHRASE_REGEXES = PHRASES.map(p => ({
  re: new RegExp("\\b" + p.replace(/\s+/g, "\\s+") + "\\b", "g"),
  to: p.replace(/\s+/g, "_")
}));

const normalizeTextBase = (s) => {
  let x = String(s ?? "").toLowerCase().replace(/[\u2010-\u2015]/g, "-");
  SYNONYM_MAP.forEach(m => { x = x.replace(m.re, m.to); });
  PHRASE_REGEXES.forEach(m => { x = x.replace(m.re, m.to); });
  return x.replace(/[^a-z0-9._\s]/g, " ").replace(/\s+/g, " ").trim();
};

const rootCache = new Map();
const searchTermToRoot = (term) => {
  if (!term) return "(blank)";
  if (rootCache.has(term)) return rootCache.get(term);
  const base = normalizeTextBase(term);
  const mags = [...(base.match(MAG_RE) || [])].map(Number).filter(n => n >= 1 && n <= 4).map(String);
  const tokens = base.split(" ").filter(Boolean);
  const kept = tokens.filter(t => !(/^\d+(\.\d+)?$/.test(t) || STOP_WORDS.has(t) || (t.length > 4 && t.endsWith("s") && (t=t.slice(0,-1)))));
  const root = [...new Set(kept), ...new Set(mags.map(v=>`+${v}`))].join(" | ").trim();
  const res = root || "(blank)";
  if (rootCache.size < 100000) rootCache.set(term, res);
  return res;
};
const rootToPhrase = (root) => (String(root || "").trim() || "(blank)") === "(blank)" ? "" : root.split("|").map(x => x.trim()).filter(Boolean).map(p => p.startsWith("+") ? p.slice(1) : p).join(" ").replace(/\s+/g," ").trim();

/** =========================
 * Word Frequency
 * ========================= */
let WF_MODE = "token";
let wfSort = { key: "spend", dir: "desc" };

const tokenize = (s) => normalizeTextBase(s).split(" ").filter(t => t && !STOP_WORDS.has(t));
const ngrams = (tokens, n) => tokens.length < n ? [] : Array.from({length: tokens.length - n + 1}, (_, i) => tokens.slice(i, i + n).join(" "));
const extractMagnification = (s) => [...String(s || "").matchAll(/\b([1-4](?:\.\d{1,2})?)\b/g)].map(m => m[1]);

/** =========================
 * Column mapping
 * ========================= */
const COL_MAP_ALIASES = {
  date: ["æ—¥æœŸ","Date","Day","Report Date"],
  portfolio: ["å¹¿å‘Šç»„åˆåç§°","Portfolio name","Portfolio","Portfolio Name"],
  campaign: ["å¹¿å‘Šæ´»åŠ¨åç§°","Campaign name","Campaign","Campaign Name"],
  adGroup: ["å¹¿å‘Šç»„åç§°","Ad group name","Ad group","Ad Group","Ad Group Name"],
  targeting: ["æŠ•æ”¾","Targeting","Keyword or Product Targeting"],
  matchType: ["åŒ¹é…ç±»å‹","Match type","Match Type"],
  searchTerm: ["å®¢æˆ·æœç´¢è¯","Customer search term","Search term","Search Term"],
  impr: ["å±•ç¤ºé‡","Impressions","Impr"],
  clicks: ["ç‚¹å‡»é‡","Clicks"],
  spend: ["èŠ±è´¹","Spend","Cost"],
  sales7d: ["7å¤©æ€»é”€å”®é¢","7 Day Total Sales","7-day total sales","7 day total sales","Total Sales","Est. Total Sales"],
  orders7d: ["7å¤©æ€»è®¢å•æ•°","7å¤©æ€»è®¢å•æ•° (#)","7å¤©æ€»è®¢å•æ•°(#)","7å¤©æ€»è®¢å•æ•°ï¼ˆ#ï¼‰","7 Day Total Orders (#)","7-day total orders","7 day total orders","Total Orders","Est. Total Orders"],
  ctr: ["ç‚¹å‡»ç‡","CTR"],
  cpc: ["æ¯æ¬¡ç‚¹å‡»è´¹ç”¨","CPC","Cost per click","Cost per click (CPC)"],
  cvr: ["7å¤©çš„è½¬åŒ–ç‡","7 Day Conversion Rate","7-day conversion rate","7 day conversion rate"],
  acos: ["ACOS","Acos"],
  roas: ["ROAS","Roas"],
};

const pickCol = (header, aliases) => {
  const normHeader = header.map(h => String(h).trim().toLowerCase());
  for (const a of aliases) {
    const target = String(a).trim().toLowerCase();
    const idx = normHeader.indexOf(target);
    if (idx >= 0) return header[idx];
  }
  return null;
};
const buildMap = (rows) => {
  const header = rows.length ? Object.keys(rows[0]) : [];
  const map = {};
  for (const key in COL_MAP_ALIASES) map[key] = pickCol(header, COL_MAP_ALIASES[key]);
  if (!map.date) throw new Error("æœªè¯†åˆ«åˆ°æ—¥æœŸåˆ—ï¼ˆDate/æ—¥æœŸï¼‰ã€‚è¯·æ£€æŸ¥ä½ çš„æŠ¥è¡¨åˆ—åã€‚");
  return map;
};
const normalizeRow = (raw, map, sourceFile) => {
  const impr = safeNum(raw[map.impr]), clicks = safeNum(raw[map.clicks]), spend = safeNum(raw[map.spend]);
  const sales = safeNum(raw[map.sales7d]), orders = safeNum(raw[map.orders7d]);
  
  return {
    sourceFile, date: toISODate(raw[map.date]),
    portfolio: String(raw[map.portfolio] ?? "").trim(), campaign: String(raw[map.campaign] ?? "").trim(),
    adGroup: String(raw[map.adGroup] ?? "").trim(), targeting: String(raw[map.targeting] ?? "").trim(),
    matchType: String(raw[map.matchType] ?? "").trim(), searchTerm: String(raw[map.searchTerm] ?? "").trim(),
    searchTermRoot: searchTermToRoot(String(raw[map.searchTerm] ?? "").trim()),
    impr, clicks, spend, sales, orders,
    ctr: map.ctr ? safeNum(raw[map.ctr]) : (impr > 0 ? clicks / impr : 0),
    cpc: map.cpc ? safeNum(raw[map.cpc]) : (clicks > 0 ? spend / clicks : 0),
    cvr: map.cvr ? safeNum(raw[map.cvr]) : (clicks > 0 ? orders / clicks : 0),
    acos: map.acos ? safeNum(raw[map.acos]) : (sales > 0 ? spend / sales : 0),
    roas: map.roas ? safeNum(raw[map.roas]) : (spend > 0 ? sales / spend : 0),
  };
};

/** =========================
 * ASIN detector (Optimized)
 * ========================= */
const ASIN_CANDIDATE_RE = /[A-Z0-9]{10}/ig;
const ASIN_STRICT_RE = /^[B0-9][A-Z0-9]{9}$/i;

const isASINLike = (s) => {
  const x = String(s || "").trim();
  if (!x) return false;
  // Use regex to find candidates
  const candidates = x.match(ASIN_CANDIDATE_RE);
  if (!candidates) return false;
  
  for (const c of candidates) {
      if (ASIN_STRICT_RE.test(c) && /\d/.test(c)) return true;
  }
  return /asin\s*=\s*[A-Z0-9]{10}/i.test(x) || /asin\s*:\s*[A-Z0-9]{10}/i.test(x);
};
const detectRowType = (name, rankBy) => (rankBy === "searchTerm" || rankBy === "searchTermRoot" || rankBy === "targeting") ? (isASINLike(name) ? "asin" : "keyword") : "other";

/** =========================
 * State
 * ========================= */
let ALL = [], VIEW = [], importedFiles = [], trendChart = null;
let rankSort = { key: "spend", dir: "desc" };
let RANK_ROWS = [], rankTypeFilter = "all";
let actionTypeFilter = "all", BID_ROWS = [], NEG_ROWS = [];
let LONG_TAIL_ROWS = [];

/** =========================
 * Importers
 * ========================= */
const parseCSV = (file) => new Promise((r,j)=>Papa.parse(file, {header:true, skipEmptyLines:true, complete:res=>r(res.data), error:j}));
const parseXLSX = (file) => new Promise((r,j)=>{
  const reader = new FileReader();
  reader.onload = (e)=>{try{const wb=XLSX.read(new Uint8Array(e.target.result),{type:"array"});r(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{defval:""}));}catch(err){j(err);}};
  reader.onerror = j; reader.readAsArrayBuffer(file);
});
const dedupeRows = (rows) => {
  const seen = new Set(), out = [];
  for (const r of rows) {
    const key = [r.date, r.portfolio, r.campaign, r.adGroup, r.targeting, r.matchType, r.searchTerm, r.spend.toFixed(4), r.sales.toFixed(4), String(r.orders)].join("|");
    if (!seen.has(key)) { seen.add(key); out.push(r); }
  } return out;
};

const importMultipleFiles = async (files) => {
  clearLog();
  if (!libsCheck()) return;

  const mergeMode = $("mergeMode").value, dedupeMode = $("dedupeMode").value;
  const maxRows = clamp(safeNum($("maxRows").value) || 250000, 10000, 2000000);

  log(`å¼€å§‹å¯¼å…¥ï¼š${files.length} ä¸ªæ–‡ä»¶ï¼ˆmerge=${mergeMode}, dedupe=${dedupeMode}, maxRows=${maxRows}ï¼‰`);
  setSubtitle("æ­£åœ¨å¯¼å…¥æ–‡ä»¶â€¦ï¼ˆè¯·çœ‹å·¦ä¾§å¯¼å…¥æ—¥å¿—ï¼‰");

  if (mergeMode === "replace") { 
    ALL = []; 
    importedFiles = []; 
    rootCache.clear(); 
    log("Replace æ¨¡å¼ï¼šå·²æ¸…ç©ºå†å²æ•°æ®ä¸ç¼“å­˜", "warn"); 
  }

  for (const file of files) {
    const name = file.name, lower = name.toLowerCase(); log(`è¯»å–æ–‡ä»¶ï¼š${name}`);
    try {
      let rows = [];
      if (lower.endsWith(".csv")) { log(`è§£æ CSVï¼š${name}`); rows = await parseCSV(file); }
      else if (lower.endsWith(".xlsx") || lower.endsWith(".xls")) { log(`è§£æ XLSX/XLSï¼š${name}`); rows = await parseXLSX(file); }
      else { log(`è·³è¿‡ï¼šä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹ï¼ˆ${name}ï¼‰`, "warn"); continue; }

      rows = rows.filter(r => r && Object.keys(r).length > 0);
      if (!rows.length) { log(`è­¦å‘Šï¼š${name} è§£æåä¸ºç©º`, "warn"); continue; }
      if (rows.length > maxRows) { log(`è­¦å‘Šï¼š${name} è¡Œæ•° ${rows.length.toLocaleString()} è¶…è¿‡ maxRowsï¼Œå°†æˆªæ–­åˆ° ${maxRows.toLocaleString()}`, "warn"); rows = rows.slice(0, maxRows); }

      log(`è¯†åˆ«å­—æ®µæ˜ å°„ï¼š${name}`); const map = buildMap(rows);
      log(`æ ‡å‡†åŒ–å­—æ®µ + ç”Ÿæˆ Rootï¼š${name}`); const normalized = rows.map(r => normalizeRow(r, map, name)).filter(r => r.date);
      log(`è¿½åŠ ï¼š${name} â†’ ${normalized.length.toLocaleString()} è¡Œ`, "good");
      ALL = ALL.concat(normalized); importedFiles.push({ name, rows: normalized.length });
      await new Promise(r => setTimeout(r, 0));
    } catch (err) { log(`é”™è¯¯ï¼š${name} å¯¼å…¥å¤±è´¥ï¼š${err?.message || err}`, "bad"); }
  }

  if (!ALL.length) {
    log("å¯¼å…¥ç»“æŸï¼šALL ä¸ºç©ºã€‚è¯·é‡ç‚¹æ£€æŸ¥ï¼š1) ä¾èµ–åº“æ˜¯å¦åŠ è½½ 2) æ˜¯å¦å­˜åœ¨ Date/æ—¥æœŸåˆ— 3) æ—¥æœŸæ˜¯å¦èƒ½è§£æ", "bad");
    setSubtitle("å¯¼å…¥ç»“æŸï¼šæ•°æ®ä¸ºç©ºï¼ˆè¯·çœ‹å·¦ä¾§å¯¼å…¥æ—¥å¿—ï¼‰");
  } else {
    if (dedupeMode === "on") { const before = ALL.length; ALL = dedupeRows(ALL); log(`å»é‡å®Œæˆï¼š${before.toLocaleString()} â†’ ${ALL.length.toLocaleString()}`, "good"); }
    const dates = ALL.map(r => r.date).filter(Boolean).sort();
    $("dateStart").value = dates[0]; $("dateEnd").value = dates[dates.length - 1];
    log(`å¯¼å…¥å®Œæˆï¼šæ–‡ä»¶ ${importedFiles.length} ä¸ªï¼›ALL=${ALL.length.toLocaleString()} è¡Œ`, "good");
    setSubtitle(`å¯¼å…¥å®Œæˆï¼šæ–‡ä»¶ ${importedFiles.length} ä¸ªï¼›ALL=${ALL.length.toLocaleString()} è¡Œï¼›æ—¥æœŸèŒƒå›´ ${$("dateStart").value} â†’ ${$("dateEnd").value}`);
  }
  renderFileList(); populateDropdowns(); applyFilters(true);
};

const renderFileList = () => {
  const box = $("fileList");
  box.innerHTML = importedFiles.length ? importedFiles.map(f=>`
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;padding:6px 8px;border-radius:10px;">
      <div style="font-size:12px;color:var(--text);word-break:break-all;">${escapeHtml(f.name)}</div>
      <div style="font-size:11.5px;color:var(--muted);white-space:nowrap;">${fmtInt(f.rows)} rows</div>
    </div>
  `).join("") : `<div class="small">æš‚æ— </div>`;
};

/** =========================
 * Dropdowns
 * ========================= */
const uniqSorted = (arr) => Array.from(new Set(arr.filter(Boolean))).sort((a,b)=>a.localeCompare(b));
const setSingleSelectOptions = (select, values, allLabel="All") => {
  const cur = select.value; select.innerHTML = `<option value="">${allLabel}</option>` + values.map(v => `<option value="${v}">${v}</option>`).join("");
  if ([...select.options].some(o=>o.value===cur)) select.value = cur;
};
const populateDropdowns = () => {
  const dropdowns = [
    { id: "filterSource", mapFn: r => r.sourceFile, allLabel: "All Files" },
    { id: "filterPortfolio", mapFn: r => r.portfolio },
    { id: "filterCampaign", mapFn: r => r.campaign },
    { id: "filterAdGroup", mapFn: r => r.adGroup },
    { id: "filterTargeting", mapFn: r => r.targeting },
    { id: "filterMatchType", mapFn: r => r.matchType },
  ];
  dropdowns.forEach(({ id, mapFn, allLabel }) => setSingleSelectOptions($(id), uniqSorted(ALL.map(mapFn)), allLabel));
  wireCascade();
};

const wireCascade = () => {
  const updateChildDropdowns = (currentFilterId, childFilterIds, mapFns) => {
    const filters = ["filterSource", "filterPortfolio", "filterCampaign"].reduce((acc, id) => ({ ...acc, [id]: $(id).value }), {});
    let rows = ALL;
    for (const key in filters) if (filters[key]) rows = rows.filter(r => r[key.replace("filter", "").toLowerCase()] === filters[key]);
    childFilterIds.forEach((childId, i) => setSingleSelectOptions($(childId), uniqSorted(rows.map(mapFns[i]))));
    autoApply();
  };
  $("filterSource").onchange = () => {
    ["filterPortfolio", "filterCampaign", "filterAdGroup", "filterTargeting", "filterMatchType"].forEach(id => ($(id).value = ""));
    populateDropdowns(); autoApply();
  };
  $("filterPortfolio").onchange = () => updateChildDropdowns("filterPortfolio", ["filterCampaign", "filterAdGroup"], [r => r.campaign, r => r.adGroup]);
  $("filterCampaign").onchange = () => updateChildDropdowns("filterCampaign", ["filterAdGroup"], [r => r.adGroup]);
};

/** =========================
 * Aggregations
 * ========================= */
const withinDate = (r, start, end) => (!start || r.date >= start) && (!end || r.date <= end);
// [ä¿®æ”¹] æ”¯æŒ exact å‚æ•°
const includesSearch = (r, q, exact) => (!q || (exact ? (r.searchTerm||"").toLowerCase() === q.toLowerCase() : (r.searchTerm || "").toLowerCase().includes(q.toLowerCase())));

const sumMetrics = (rows) => {
  const sums = { impr:0, clicks:0, spend:0, sales:0, orders:0 };
  for (const r of rows) for (const k in sums) sums[k] += r[k];
  return {
    ...sums,
    ctr: sums.impr > 0 ? sums.clicks / sums.impr : 0,
    cpc: sums.clicks > 0 ? sums.spend / sums.clicks : 0,
    cvr: sums.clicks > 0 ? sums.orders / sums.clicks : 0,
    acos: sums.sales > 0 ? sums.spend / sums.sales : 0,
    roas: sums.spend > 0 ? sums.sales / sums.spend : 0,
  };
};
const groupBy = (rows, keyFn) => {
  const mp = new Map();
  for (const r of rows) { const k = keyFn(r) || "(blank)"; (mp.has(k) ? mp : mp.set(k, [])).get(k).push(r); }
  return mp;
};

/** =========================
 * Word Frequency Builder
 * ========================= */
const buildWordStats = () => {
  const minFreq = Math.max(1, Math.floor(safeNum($("wfMinFreq")?.value ?? 3)));
  const minSpend = Math.max(0, safeNum($("wfMinSpend")?.value ?? 10));
  const mp = new Map();

  for (const r of VIEW) {
    const term = r.searchTerm || "";
    let words = [];
    if (WF_MODE === "token") words = tokenize(term);
    else if (WF_MODE === "bigram") words = ngrams(tokenize(term), 2);
    else if (WF_MODE === "trigram") words = ngrams(tokenize(term), 3);
    else if (WF_MODE === "mag") words = extractMagnification(term);

    const uniqueWords = new Set(words); 
    for (const w of uniqueWords) {
      if (!w) continue;
      if (!mp.has(w)) mp.set(w, []);
      mp.get(w).push(r);
    }
  }

  let out = [];
  for (const [word, rows] of mp.entries()) {
    const m = sumMetrics(rows);
    if (rows.length < minFreq) continue;
    if (m.spend < minSpend) continue;
    const action =
      (m.spend >= 30 && m.orders === 0) ? "NEGATE" :
      (m.orders >= 2 || m.roas >= 3) ? "KEEP" : "WATCH";
    out.push({ word, freq: rows.length, ...m, action });
  }

  const {key, dir} = wfSort;
  const mul = dir==="asc" ? 1 : -1;
  out.sort((a,b)=>{
    const av = (key==="word"||key==="action") ? String(a[key]||"") : (a[key] ?? 0);
    const bv = (key==="word"||key==="action") ? String(b[key]||"") : (b[key] ?? 0);
    return (typeof av === "string" ? av.localeCompare(bv) : (av > bv ? 1 : -1)) * mul;
  });
  return out.slice(0, 100);
};

const renderWordFreq = () => {
  const tbody = $("wfTable")?.querySelector("tbody");
  if (!tbody) return;
  if (!VIEW.length) { tbody.innerHTML = ""; return; }
  const rows = buildWordStats();
  tbody.innerHTML = rows.map(r => `
    <tr data-word="${escapeHtml(r.word)}" style="cursor:pointer;">
      <td title="${escapeHtml(r.word)}">${escapeHtml(r.word).slice(0, 180)}</td>
      <td>${fmtInt(r.freq)}</td>
      <td>${fmtMoney(r.spend)}</td>
      <td>${fmtInt(r.orders)}</td>
      <td>${(r.roas ?? 0).toFixed(2)}</td>
      <td style="${r.acos > 0.4 ? 'color:#b42318;' : ''}">${fmtPct(r.acos)}</td>
      <td>${actionTag(r.action)}</td>
    </tr>
  `).join("");
};

/** =========================
 * Long Tail Keyword Mining (List)
 * ========================= */
const renderLongTailMining = () => {
  const tbody = $("longTailTable")?.querySelector("tbody");
  if (!tbody) return;
  if (!VIEW.length) { tbody.innerHTML = ""; return; }

  const minWords = Math.max(1, Math.floor(safeNum($("ltMinWords").value)));
  const minOrders = Math.max(0, Math.floor(safeNum($("ltMinOrders").value)));
  const minRoas = safeNum($("ltMinRoas").value);

  const groups = groupBy(VIEW, r => r.searchTerm);
  const candidates = [];

  for (const [term, rows] of groups.entries()) {
    if (isASINLike(term)) continue;
    const wordCount = (term || "").trim().split(/\s+/).filter(Boolean).length;
    if (wordCount < minWords) continue;

    const m = sumMetrics(rows);
    if (m.orders < minOrders) continue;
    if (m.roas < minRoas) continue;

    candidates.push({ term, wordCount, ...m });
  }

  candidates.sort((a,b) => b.sales - a.sales);
  LONG_TAIL_ROWS = candidates; 

  tbody.innerHTML = candidates.slice(0, 50).map(c => `
    <tr>
      <td title="${escapeHtml(c.term)}">${escapeHtml(c.term).slice(0, 80)}</td>
      <td>${c.wordCount}</td>
      <td>${fmtMoney(c.spend)}</td>
      <td>${fmtMoney(c.sales)}</td>
      <td>${fmtInt(c.orders)}</td>
      <td>${c.roas.toFixed(2)}</td>
      <td style="${c.acos > 0.4 ? 'color:#b42318;' : ''}">${fmtPct(c.acos)}</td>
    </tr>
  `).join("");

  if (candidates.length === 0) {
    tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:20px;">æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„é•¿å°¾è¯ï¼ˆå°è¯•é™ä½â€œå•è¯æ•°â€æˆ–â€œè®¢å•â€é—¨æ§›ï¼‰</td></tr>`;
  }
};

const exportLongTailCSV = () => {
    if (!LONG_TAIL_ROWS.length) { alert("å½“å‰åˆ—è¡¨ä¸ºç©ºï¼Œæ— æ•°æ®å¯å¯¼å‡ºã€‚"); return; }
    const rows = [["Search Term", "Word Count", "Spend", "Sales", "Orders", "ROAS", "ACOS"]];
    for (const c of LONG_TAIL_ROWS) {
        rows.push([
            c.term, c.wordCount, c.spend.toFixed(2), c.sales.toFixed(2), c.orders, c.roas.toFixed(2), (c.acos*100).toFixed(2)+"%"
        ]);
    }
    const filename = `long_tail_mining_${$("dateStart").value}_${getTs()}.csv`;
    downloadText(filename, toCSV(rows));
};

/** =========================
 * Weekday Analysis
 * ========================= */
const renderWeekdayAnalysis = () => {
  const tbody = $("weekdayTable")?.querySelector("tbody");
  if (!tbody) return;
  if (!VIEW.length) { tbody.innerHTML = ""; return; }

  const days = ["å‘¨æ—¥ (Sun)", "å‘¨ä¸€ (Mon)", "å‘¨äºŒ (Tue)", "å‘¨ä¸‰ (Wed)", "å‘¨å›› (Thu)", "å‘¨äº” (Fri)", "å‘¨å…­ (Sat)"];
  const bins = days.map(()=>[]);
  
  for (const r of VIEW) {
    if(!r.date) continue;
    const parts = r.date.split("-");
    if(parts.length === 3) {
       // Construct date as local, using 12:00 to avoid any DST shifts or timezone boundary issues
       const localDate = new Date(Number(parts[0]), Number(parts[1])-1, Number(parts[2]), 12, 0, 0);
       bins[localDate.getDay()].push(r);
    }
  }

  const result = bins.map((rows, i) => ({ day: days[i], ...sumMetrics(rows) }));
  const totalSales = sumMetrics(VIEW).sales || 1;

  tbody.innerHTML = result.map(row => {
    const salesPct = totalSales > 0 ? (row.sales / totalSales) : 0;
    const barHtml = `
      <div class="bar-row">
        <div style="width:40px;text-align:right;color:var(--muted);margin-right:6px;">${(salesPct*100).toFixed(1)}%</div>
        <div class="bar-track">
           <div style="width:${salesPct*100}%;background:var(--accent)"></div>
        </div>
      </div>
    `;
    return `
      <tr>
        <td>${row.day}</td>
        <td>${barHtml}</td>
        <td>${fmtMoney(row.spend)}</td>
        <td>${fmtMoney(row.sales)}</td>
        <td>${fmtInt(row.orders)}</td>
        <td>${row.roas.toFixed(2)}</td>
        <td style="${row.acos > 0.4 ? 'color:#b42318;' : ''}">${fmtPct(row.acos)}</td>
        <td>${fmtMoney(row.cpc)}</td>
      </tr>
    `;
  }).join("");
};

/** =========================
 * CPC Distribution Analysis
 * ========================= */
const renderCPCDistribution = () => {
  const tbody = $("cpcDistTable")?.querySelector("tbody");
  if (!tbody) return;
  if (!VIEW.length) { tbody.innerHTML = ""; return; }

  const buckets = [
      { label: "< 0.50", min:0, max:0.5, rows: [] },
      { label: "0.50 - 1.00", min:0.5, max:1.0, rows: [] }
  ];

  for (let i = 10; i < 20; i++) {
      const start = i / 10;
      const end = (i + 1) / 10;
      buckets.push({
          label: `${start.toFixed(2)} - ${end.toFixed(2)}`,
          min: start,
          max: end,
          rows: []
      });
  }

  buckets.push(
      { label: "2.00 - 3.00", min:2.0, max:3.0, rows: [] },
      { label: "3.00 - 5.00", min:3.0, max:5.0, rows: [] },
      { label: "> 5.00", min:5.0, max:9999, rows: [] }
  );

  for (const r of VIEW) {
      if (r.clicks <= 0) continue; 
      const rowCpc = r.spend / r.clicks;
      for(const b of buckets) {
          if (rowCpc >= b.min && rowCpc < b.max) {
              b.rows.push(r);
              break;
          }
      }
  }

  const result = buckets.map(b => ({ ...b, metrics: sumMetrics(b.rows) }));
  const totalSales = sumMetrics(VIEW).sales || 1;

  tbody.innerHTML = result.map(b => {
    const m = b.metrics;
    if (m.impr === 0 && m.spend === 0) return ""; 
    
    const salesPct = totalSales > 0 ? (m.sales / totalSales) : 0;
    const barHtml = `
      <div class="bar-row">
        <div style="width:40px;text-align:right;color:var(--muted);margin-right:6px;">${(salesPct*100).toFixed(1)}%</div>
        <div class="bar-track">
           <div style="width:${salesPct*100}%;background:var(--accent)"></div>
        </div>
      </div>
    `;

    return `
      <tr>
        <td>${b.label}</td>
        <td>${barHtml}</td>
        <td>${fmtMoney(m.spend)}</td>
        <td>${fmtMoney(m.sales)}</td>
        <td>${fmtInt(m.orders)}</td>
        <td style="${m.roas >= 3 ? 'color:#1a7f37;font-weight:700' : ''}">${m.roas.toFixed(2)}</td>
        <td style="${m.acos > 0.4 ? 'color:#b42318;' : ''}">${fmtPct(m.acos)}</td>
        <td>${fmtPct(m.cvr)}</td>
      </tr>
    `;
  }).join("");
};

/** =========================
 * Keyword Length Analysis
 * ========================= */
const renderLengthAnalysis = () => {
  const tbody = $("lengthTable")?.querySelector("tbody");
  if (!tbody) return;
  if (!VIEW.length) { tbody.innerHTML = ""; return; }

  const buckets = Array.from({length:7}, (_,i)=>({ len:i+1, rows:[] })); // 1,2,3,4,5,6,7+
  
  for (const r of VIEW) {
    if(!r.searchTerm) continue;
    const len = r.searchTerm.trim().split(/\s+/).filter(Boolean).length;
    if(len >= 7) buckets[6].rows.push(r);
    else if(len >= 1) buckets[len-1].rows.push(r);
  }

  const result = buckets.map(b => ({ ...b, metrics: sumMetrics(b.rows) }));
  const totalSpend = sumMetrics(VIEW).spend || 1;

  tbody.innerHTML = result.map(b => {
    const m = b.metrics;
    if(m.spend === 0 && m.impr === 0) return "";

    const label = b.len === 7 ? "7+ Words" : `${b.len} Word${b.len>1?'s':''}`;
    const spendPct = totalSpend > 0 ? (m.spend / totalSpend) : 0;
    const barHtml = `
      <div class="bar-row">
        <div style="width:40px;text-align:right;color:var(--muted);margin-right:6px;">${(spendPct*100).toFixed(1)}%</div>
        <div class="bar-track">
           <div style="width:${spendPct*100}%;background:var(--accent)"></div>
        </div>
      </div>
    `;

    return `
      <tr>
        <td>${label}</td>
        <td>${barHtml}</td>
        <td>${fmtMoney(m.spend)}</td>
        <td>${fmtMoney(m.sales)}</td>
        <td>${fmtInt(m.orders)}</td>
        <td>${m.roas.toFixed(2)}</td>
        <td style="${m.acos > 0.4 ? 'color:#b42318;' : ''}">${fmtPct(m.acos)}</td>
        <td>${fmtPct(m.cvr)}</td>
      </tr>
    `;
  }).join("");
};

/** =========================
 * Match Type Analysis
 * ========================= */
const renderMatchTypeAnalysis = () => {
  const tbody = $("matchTypeTable")?.querySelector("tbody");
  if (!tbody) return;
  if (!VIEW.length) { tbody.innerHTML = ""; return; }

  const types = ["Exact", "Phrase", "Broad", "Auto", "Other"];
  const bins = { "Exact":[], "Phrase":[], "Broad":[], "Auto":[], "Other":[] };

  for (const r of VIEW) {
     const m = (r.matchType || "").toLowerCase();
     if(m.includes("exact")) bins["Exact"].push(r);
     else if(m.includes("phrase")) bins["Phrase"].push(r);
     else if(m.includes("broad")) bins["Broad"].push(r);
     else if(m === "-" || m === "") bins["Auto"].push(r); 
     else bins["Auto"].push(r); // default to Auto for unknowns
  }

  const result = types.map(t => ({ type:t, ...sumMetrics(bins[t]) }));
  const totalSpend = sumMetrics(VIEW).spend || 1;

  tbody.innerHTML = result.map(row => {
    if(row.spend === 0 && row.impr === 0) return "";
    const spendPct = totalSpend > 0 ? (row.spend / totalSpend) : 0;
    const barHtml = `
      <div class="bar-row">
        <div style="width:40px;text-align:right;color:var(--muted);margin-right:6px;">${(spendPct*100).toFixed(1)}%</div>
        <div class="bar-track">
           <div style="width:${spendPct*100}%;background:var(--accent)"></div>
        </div>
      </div>
    `;
    return `
      <tr>
        <td>${row.type}</td>
        <td>${barHtml}</td>
        <td>${fmtMoney(row.spend)}</td>
        <td>${fmtMoney(row.sales)}</td>
        <td>${fmtInt(row.orders)}</td>
        <td>${row.roas.toFixed(2)}</td>
        <td style="${row.acos > 0.4 ? 'color:#b42318;' : ''}">${fmtPct(row.acos)}</td>
        <td>${fmtMoney(row.cpc)}</td>
        <td>${fmtPct(row.cvr)}</td>
      </tr>
    `;
  }).join("");
};


/** =========================
 * Auto / Manual Comparison
 * ========================= */
const renderAutoManual = () => {
  if (!VIEW.length) return;
  const tbody = $("autoManualTable")?.querySelector("tbody");
  if (!tbody) return;
  // [ä¼˜åŒ–] æ‰‹åŠ¨å¹¿å‘Šåˆ¤å®šé€»è¾‘åŠ å¼º (Broad, Phrase, Exact, Product, Targeting)
  const isManual = (t) => {
      const lower = (t||"").toLowerCase();
      return ["broad","phrase","exact"].includes(lower) || lower.includes("product") || lower.includes("targeting");
  };
  const autoRows = [], manualRows = [];
  for (const r of VIEW) {
    if (isManual(r.matchType)) manualRows.push(r);
    else autoRows.push(r);
  }
  const sA = sumMetrics(autoRows), sM = sumMetrics(manualRows);
  const row = (label, vA, vM, fmt, highlightAcos=false) => {
    let pctA = 0, pctM = 0;
    const total = (vA||0) + (vM||0);
    if (total > 0 && !label.includes("ç‡") && !label.includes("ACOS") && !label.includes("ROAS") && !label.includes("CPC")) {
       pctA = (vA/total); pctM = (vM/total);
    }
    const colorA = highlightAcos && vA > 0.4 ? 'color:#b42318' : '';
    const colorM = highlightAcos && vM > 0.4 ? 'color:#b42318' : '';
    let barHtml = `<div style="color:var(--muted);font-size:11px;">â€”</div>`;
    if (total > 0 && pctA+pctM > 0) {
      barHtml = `
        <div class="bar-row">
          <div style="flex:1;text-align:right;color:var(--muted)">${(pctA*100).toFixed(0)}%</div>
          <div class="bar-track">
             <div style="width:${pctA*100}%;background:var(--accent)"></div>
          </div>
          <div style="flex:1;text-align:left;color:var(--muted)">${(pctM*100).toFixed(0)}%</div>
        </div>
      `;
    }
    return `<tr>
      <td>${label}</td>
      <td style="${colorA}">${fmt(vA)}</td>
      <td style="${colorM}">${fmt(vM)}</td>
      <td>${barHtml}</td>
    </tr>`;
  };
  tbody.innerHTML = 
    row("èŠ±è´¹", sA.spend, sM.spend, fmtMoney) +
    row("é”€å”®é¢", sA.sales, sM.sales, fmtMoney) +
    row("è®¢å•æ•°", sA.orders, sM.orders, fmtInt) +
    row("ACOS", sA.acos, sM.acos, fmtPct, true) +
    row("ROAS", sA.roas, sM.roas, (v)=>v.toFixed(2)) +
    row("è½¬åŒ–ç‡ (CVR)", sA.cvr, sM.cvr, fmtPct) +
    row("ç‚¹å‡»æˆæœ¬ (CPC)", sA.cpc, sM.cpc, fmtMoney);
};

/** =========================
 * Conflict Analysis (NEW)
 * ========================= */
const renderConflictAnalysis = () => {
  const tbody = $("conflictTable")?.querySelector("tbody");
  if (!tbody) return;
  if (!VIEW.length) { tbody.innerHTML = ""; return; }

  const map = new Map();
  // Group by Search Term, record unique Locations
  for (const r of VIEW) {
    if (!r.searchTerm || isASINLike(r.searchTerm)) continue; // Skip ASINs
    if (!map.has(r.searchTerm)) map.set(r.searchTerm, { rows: [], locations: new Set() });
    const entry = map.get(r.searchTerm);
    entry.rows.push(r);
    // Key for location: Campaign > AdGroup
    entry.locations.add(`${r.campaign} > ${r.adGroup}`);
  }

  const conflicts = [];
  for (const [term, data] of map.entries()) {
    // Conflict definition: Appears in > 1 unique Ad Group location
    if (data.locations.size > 1) {
      const m = sumMetrics(data.rows);
      // Only care if spend > some minimal amount to avoid noise
      if (m.spend > 5) {
        conflicts.push({
          term,
          count: data.locations.size,
          locs: Array.from(data.locations),
          ...m
        });
      }
    }
  }

  // Sort by Spend descending (focus on costly conflicts)
  conflicts.sort((a,b) => b.spend - a.spend);

  if (conflicts.length === 0) {
      tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:20px;color:var(--muted)">æœªæ£€æµ‹åˆ°æ˜æ˜¾çš„å†…éƒ¨ç«äº‰ï¼ˆæ¡ä»¶ï¼šä¸åŒå¹¿å‘Šç»„æ•° > 1 ä¸” èŠ±è´¹ > 5ï¼‰</td></tr>`;
      return;
  }

  tbody.innerHTML = conflicts.slice(0, 50).map(c => {
    // Format locations for display: first 2, then count
    const displayLocs = c.locs.slice(0, 2).map(l => `<div style="font-size:11px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${escapeHtml(l)}</div>`).join("");
    const moreCount = c.locs.length > 2 ? `<div style="font-size:10px;color:var(--muted)">+${c.locs.length - 2} more...</div>` : "";
    
    // Join all locations for tooltip
    const fullLocs = c.locs.join("\n");

    return `
      <tr data-term="${escapeHtml(c.term)}" style="cursor:pointer" title="ç‚¹å‡»ç­›é€‰è¯¥è¯">
        <td style="font-weight:600;color:var(--text)">${escapeHtml(c.term)}</td>
        <td><span class="tag bad" style="font-size:11px">${c.count}ä¸ª</span></td>
        <td title="${escapeHtml(fullLocs)}">${displayLocs}${moreCount}</td>
        <td>${fmtMoney(c.spend)}</td>
        <td>${fmtInt(c.orders)}</td>
        <td>${c.roas.toFixed(2)}</td>
      </tr>
    `;
  }).join("");
};

// Add listener for conflict table click
$("conflictTable").addEventListener("click", (e) => {
  const tr = e.target.closest("tr");
  if (!tr || !tr.dataset.term) return;
  $("filterSearchTerm").value = tr.dataset.term;
  applyFilters();
});


/** =========================
 * Actions (è‡ªåŠ¨åˆ¤å®š)
 * ========================= */
const getRules = () => ({
  spendNeg: safeNum($("ruleSpendNeg").value), clicksNeg: Math.max(0, Math.floor(safeNum($("ruleClicksNeg").value))),
  roasNeg: safeNum($("ruleRoasNeg").value), roasKeep: safeNum($("ruleRoasKeep").value),
  ordersKeep: Math.max(0, Math.floor(safeNum($("ruleOrdersKeep").value))), roasMigrateMin: safeNum($("ruleRoasMigrateMin").value)
});

const decideAction = (item, rankBy) => {
  const r = getRules(); const reasons = [];
  const condNeg1 = item.spend >= r.spendNeg && item.orders <= 0; if (condNeg1) reasons.push(`èŠ±è´¹â‰¥${r.spendNeg} & è®¢å•æ•°=0`);
  const condNeg2 = item.clicks >= r.clicksNeg && item.roas > 0 && item.roas < r.roasNeg; if (condNeg2) reasons.push(`ç‚¹å‡»é‡â‰¥${r.clicksNeg} & ROAS<${r.roasNeg}`);
  const condNeg3 = item.clicks >= r.clicksNeg && item.sales <= 0 && item.spend >= r.spendNeg; if (condNeg3) reasons.push(`é”€å”®é¢=0 & èŠ±è´¹â‰¥${r.spendNeg}`);

  if (condNeg1 || condNeg2 || condNeg3) return { action:"NEGATE", reason: reasons.join(" â€¢ "), suggestNeg: suggestNegative(item.name, rankBy) };
  
  reasons.length = 0;
  const condKeep1 = item.roas >= r.roasKeep && item.spend > 0; if (condKeep1) reasons.push(`ROASâ‰¥${r.roasKeep}`);
  const condKeep2 = item.orders >= r.ordersKeep; if (condKeep2) reasons.push(`è®¢å•æ•°â‰¥${r.ordersKeep}`);
  if (condKeep1 || condKeep2) return { action:"KEEP", reason: reasons.join(" â€¢ "), suggestNeg:"" };

  if (item.orders > 0 && item.roas >= r.roasMigrateMin && item.roas < r.roasKeep)
    return { action:"MIGRATE", reason: `è®¢å•æ•°>0 & ROASâ‰¥${r.roasMigrateMin} & <${r.roasKeep}`, suggestNeg:"" };

  return { action:"KEEP", reason:"æ— é£é™©ä¿¡å·", suggestNeg:"" };
};

const suggestNegative = (name, rankBy) => {
  const negType = $("exportNegMatch")?.value || "phrase";
  const keyword = (rankBy === "searchTermRoot" ? rootToPhrase(name) : String(name || "").trim());
  return keyword && keyword !== "(blank)" ? `${negType.toUpperCase()}: ${keyword}` : "";
};
const actionTag = (action) => `<span class="tag ${action==="NEGATE"?"bad":action==="MIGRATE"?"warn":"good"}">${action}</span>`;

/** =========================
 * BID UP
 * ========================= */
const decideBidUp = (item) => {
  const spendBid = safeNum($("bidSpend")?.value ?? 20);
  const ordersBid = Math.max(0, Math.floor(safeNum($("bidOrders")?.value ?? 2)));
  const roasBid = safeNum($("bidRoas")?.value ?? 3.5);
  if (!(item.spend >= spendBid && item.orders >= ordersBid && item.roas >= roasBid)) return { bid:false, suggest:"" };

  let pct = 20;
  const intensity = $("bidIntensity")?.value;
  if (intensity !== "auto") pct = Number(intensity) || 20;
  else if (item.roas >= 6) pct = 30; else if (item.roas >= 4.5) pct = 20; else pct = 10;
  return { bid:true, suggest:`æé«˜ç«ä»· +${pct}%` };
};

/** =========================
 * Export (CSV Functions)
 * ========================= */
const exportNegativesCSV = () => {
  const rankBy = $("rankBy").value;
  if (!["searchTerm", "searchTermRoot"].includes(rankBy)) { log("å¯¼å‡ºå¤±è´¥ï¼šåªæœ‰åœ¨æ¦œå•ç»´åº¦ä¸º Search Term / Root æ—¶æ‰å…è®¸å¯¼å‡ºå¦å®šè¯", "bad"); alert("å¯¼å‡ºå¤±è´¥ï¼šè¯·å°†â€œæ¦œå•èšåˆç»´åº¦â€åˆ‡æ¢ä¸º Search Term æˆ– Search Term Rootï¼Œå†å¯¼å‡ºå¦å®šè¯ã€‚"); return; }
  if (!VIEW.length) { log("å¯¼å‡ºå¤±è´¥ï¼šå½“å‰è§†å›¾ä¸ºç©º", "bad"); alert("å¯¼å‡ºå¤±è´¥ï¼šå½“å‰è§†å›¾ä¸ºç©ºã€‚"); return; }

  const itemsToExport = $("exportScope").value === "rank" ? RANK_ROWS.slice() : (() => {
    const groups = groupBy(VIEW, getRankKey());
    return [...groups.entries()].map(([name, list]) => {
      const it = { name, ...sumMetrics(list) };
      const a = decideAction(it, rankBy);
      return { ...it, action:a.action, reason:a.reason, suggestNeg:a.suggestNeg };
    }).sort((a,b)=> (b.spend||0) - (a.spend||0));
  })();

  const rows = [["å…³é”®è¯","å¦å®šåŒ¹é…","åˆ†ç»„ç»´åº¦","ç†ç”±","èŠ±è´¹","é”€å”®é¢","è®¢å•æ•°","ROAS","ACOS"]];
  const seen = new Set(), negMatch = $("exportNegMatch").value.toUpperCase();

  for (const it of itemsToExport) {
    if (it.action !== "NEGATE") continue;
    const keyword = (rankBy === "searchTermRoot" ? rootToPhrase(it.name) : String(it.name || "").trim()).replace(/\s+/g," ").trim();
    if (!keyword || keyword === "(blank)") continue;
    const key = `${negMatch}:${keyword.toLowerCase()}`;
    if (!seen.has(key)) {
      seen.add(key);
      rows.push([
        keyword, negMatch, (rankBy === "searchTerm" ? "å®¢æˆ·æœç´¢è¯" : "æœç´¢è¯æ ¹"), it.reason || "",
        (it.spend ?? 0).toFixed(2), (it.sales ?? 0).toFixed(2), String(it.orders ?? 0),
        (it.roas ?? 0).toFixed(2), ((it.acos ?? 0) * 100).toFixed(2) + "%"
      ]);
    }
  }
  if (rows.length === 1) { log("æœªæ‰¾åˆ°å¯å¯¼å‡ºçš„ NEGATE é¡¹ï¼ˆè¯·è°ƒä½é˜ˆå€¼æˆ–æ‰©å¤§æ—¥æœŸèŒƒå›´ï¼‰", "warn"); alert("æœªæ‰¾åˆ°å¯å¯¼å‡ºçš„ NEGATE é¡¹ï¼ˆè¯·è°ƒä½é˜ˆå€¼æˆ–æ‰©å¤§æ—¥æœŸèŒƒå›´ï¼‰ã€‚"); return; }
  
  // [ä¿®æ”¹] å¢åŠ æ—¶é—´æˆ³
  const filename = `negatives_${rankBy}_${negMatch}_${$("dateStart").value || "start"}_${$("dateEnd").value || "end"}_${getTs()}.csv`;
  downloadText(filename, toCSV(rows));
  log(`å·²å¯¼å‡ºå¦å®šè¯ CSVï¼š${filename}ï¼ˆ${rows.length-1} æ¡ï¼‰`, "good");
};

const exportBidUpCSV = () => {
  if (!VIEW.length) { log("å¯¼å‡ºå¤±è´¥ï¼šå½“å‰è§†å›¾ä¸ºç©º", "bad"); alert("å¯¼å‡ºå¤±è´¥ï¼šå½“å‰è§†å›¾ä¸ºç©ºã€‚"); return; }
  buildActionLists();
  if (!BID_ROWS.length) { log("æœªæ‰¾åˆ°å¯å¯¼å‡ºçš„ BID UP é¡¹ï¼ˆè¯·è°ƒä½é˜ˆå€¼æˆ–æ‰©å¤§æ—¥æœŸèŒƒå›´ï¼‰", "warn"); alert("æœªæ‰¾åˆ°å¯å¯¼å‡ºçš„ BID UP é¡¹ï¼ˆè¯·è°ƒä½é˜ˆå€¼æˆ–æ‰©å¤§æ—¥æœŸèŒƒå›´ï¼‰ã€‚"); return; }

  const rows = [["ç±»å‹","åç§°","å»ºè®®","èŠ±è´¹","é”€å”®é¢","è®¢å•æ•°","ROAS","ACOS"]];
  for (const it of BID_ROWS) {
    rows.push([
      (it.type || "").toUpperCase(), String(it.name || ""), String(it.suggest || ""),
      (it.spend ?? 0).toFixed(2), (it.sales ?? 0).toFixed(2), String(it.orders ?? 0),
      (it.roas ?? 0).toFixed(2), ((it.acos ?? 0) * 100).toFixed(2) + "%"
    ]);
  }
  // [ä¿®æ”¹] å¢åŠ æ—¶é—´æˆ³
  const filename = `bidup_${$("dateStart").value || "start"}_${$("dateEnd").value || "end"}_${getTs()}.csv`;
  downloadText(filename, toCSV(rows));
  log(`å·²å¯¼å‡ºåŠ ä»·è¯ CSVï¼š${filename}ï¼ˆ${rows.length-1} æ¡ï¼‰`, "good");
};

// ======================
// NEW: Export Rank CSV Function
// ======================
const exportRankCSV = () => {
    if (!RANK_ROWS.length) { alert("å½“å‰æ¦œå•ä¸ºç©ºï¼Œæ— æ•°æ®å¯å¯¼å‡ºã€‚"); return; }
    // Define headers matching table
    const headers = ["Name", "Spend", "Sales", "Orders", "Impressions", "Clicks", "CTR", "CPC", "CVR", "ACOS", "ROAS", "Action", "Reason"];
    const rows = [headers];

    for (const r of RANK_ROWS) {
         rows.push([
            r.name,
            r.spend.toFixed(2),
            r.sales.toFixed(2),
            r.orders,
            r.impr,
            r.clicks,
            (r.ctr * 100).toFixed(2) + "%",
            r.cpc.toFixed(2),
            (r.cvr * 100).toFixed(2) + "%",
            (r.acos * 100).toFixed(2) + "%",
            r.roas.toFixed(2),
            r.action,
            r.reason
         ]);
    }
    // [ä¿®æ”¹] å¢åŠ æ—¶é—´æˆ³
    const filename = `rank_list_${$("dateStart").value || "start"}_${$("dateEnd").value || "end"}_${getTs()}.csv`;
    downloadText(filename, toCSV(rows));
    log(`å·²å¯¼å‡ºæ¦œå• CSVï¼š${filename}ï¼ˆ${rows.length-1} æ¡ï¼‰`, "good");
};

/** =========================
 * Rendering
 * ========================= */
const renderKPIs = (total) => {
  const kpis = [
    { label:"èŠ±è´¹", value: fmtMoney(total.spend), meta: `ç‚¹å‡»æˆæœ¬ ${fmtMoney(total.cpc)} â€¢ ç‚¹å‡»ç‡ ${fmtPct(total.ctr)}` },
    { label:"é”€å”®é¢ (7å¤©)", value: fmtMoney(total.sales), meta: `ROAS ${total.roas.toFixed(2)} â€¢ ACOS ${fmtPct(total.acos)}` },
    { label:"è®¢å•æ•° (7å¤©)", value: fmtInt(total.orders), meta: `è½¬åŒ–ç‡ ${fmtPct(total.cvr)} â€¢ ç‚¹å‡»é‡ ${fmtInt(total.clicks)}` },
    { label:"å±•ç¤ºé‡", value: fmtInt(total.impr), meta: `ç‚¹å‡»é‡ ${fmtInt(total.clicks)} â€¢ ç‚¹å‡»ç‡ ${fmtPct(total.ctr)}` },
    { label:"ACOS", value: fmtPct(total.acos), meta: `èŠ±è´¹/é”€å”®é¢` },
    { label:"ROAS", value: total.roas.toFixed(2), meta: `é”€å”®é¢/èŠ±è´¹` },
    { label:"ç‚¹å‡»æˆæœ¬", value: fmtMoney(total.cpc), meta: `èŠ±è´¹/ç‚¹å‡»é‡` },
    { label:"è½¬åŒ–ç‡", value: fmtPct(total.cvr), meta: `è®¢å•æ•°/ç‚¹å‡»é‡` },
  ];
  $("kpiGrid").innerHTML = kpis.map(k => `
    <div class="card kpi">
      <div class="label"><span>${k.label}</span><span class="pill">KPI</span></div>
      <div class="value">${k.value}</div>
      <div class="meta"><span>${k.meta}</span></div>
    </div>
  `).join("");
};

// [ä¼˜åŒ–] å›¾è¡¨ç½‘æ ¼çº¿è‡ªé€‚åº”æ·±è‰²æ¨¡å¼
const renderTrend = (rows) => {
  const byDate = groupBy(rows, r=>r.date);
  const series = [...byDate.keys()].sort().map(d=>({ date:d, ...sumMetrics(byDate.get(d)) }));
  const dataMap = (key, transform = v => v) => series.map(s => transform(s[key]));
  
  // è·å–å½“å‰ä¸»é¢˜å¯¹åº”çš„ç½‘æ ¼çº¿é¢œè‰²
  const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--chart-grid').trim() || "rgba(229,229,234,.6)";

  const datasets = [
    { label:"èŠ±è´¹", data:dataMap("spend"), tension:.25, pointRadius:0, borderWidth:2 },
    { label:"é”€å”®é¢", data:dataMap("sales"), tension:.25, pointRadius:0, borderWidth:2 },
    { label:"è®¢å•æ•°", data:dataMap("orders"), tension:.25, pointRadius:0, borderWidth:2 },
    { label:"ACOS %", data:dataMap("acos", v => isFinite(v) ? v*100 : 0), tension:.25, pointRadius:0, borderWidth:2, yAxisID:"y1" },
    { label:"ROAS", data:dataMap("roas", v => isFinite(v) ? v : 0), tension:.25, pointRadius:0, borderWidth:2, yAxisID:"y1" },
  ];
  // [ä¼˜åŒ–] é”€æ¯å‰æ£€æŸ¥ context é˜²æ­¢å†…å­˜æ³„æ¼
  if (trendChart) {
      trendChart.destroy();
      trendChart = null;
  }
  const ctx = $("trendChart");
  if(ctx) {
      trendChart = new Chart(ctx, {
        type:"line", data:{ labels:series.map(s=>s.date), datasets },
        options:{
          responsive:true, maintainAspectRatio:false, interaction:{ mode:"index", intersect:false },
          scales:{
            y:{ beginAtZero:true, grid:{ color: gridColor } },
            y1:{ beginAtZero:true, position:"right", grid:{ drawOnChartArea:false } },
            x:{ grid:{ display:false } }
          }
        }
      });
  }
};

const getRankKey = () => {
  const mapping = {
    searchTerm: r => r.searchTerm || "(ç©ºç™½)",
    searchTermRoot: r => r.searchTermRoot || "(ç©ºç™½)",
    targeting: r => r.targeting || "(ç©ºç™½)",
    campaign: r => r.campaign || "(ç©ºç™½)",
    adGroup: r => r.adGroup || "(ç©ºç™½)",
  };
  return mapping[$("rankBy").value];
};

const sortRank = (items) => {
  const {key, dir} = rankSort;
  const mul = dir==="asc" ? 1 : -1;
  items.sort((a,b)=>{
    const av = key==="name"||key==="action" ? String(a[key]||"") : (a[key] ?? 0);
    const bv = key==="name"||key==="action" ? String(b[key]||"") : (b[key] ?? 0);
    return (typeof av === "string" ? av.localeCompare(bv) : (av > bv ? 1 : -1)) * mul;
  });
};

const buildRankTable = (rows) => {
  const rankBy = $("rankBy").value, keyFn = getRankKey();
  let items = [...groupBy(rows, keyFn).entries()].map(([name, list]) => {
    const base = { name, ...sumMetrics(list) };
    const {action, reason, suggestNeg} = decideAction(base, rankBy);
    return { ...base, action, reason, suggestNeg };
  });
  if (rankTypeFilter !== "all") items = items.filter(it => detectRowType(it.name, rankBy) === rankTypeFilter);
  sortRank(items);
  RANK_ROWS = items.slice(0, clamp(safeNum($("rankTopN").value) || 30, 5, 500));
};

const renderRankTable = () => {
  buildRankTable(VIEW);
  $("rankTable").querySelector("tbody").innerHTML = RANK_ROWS.map(it => `
    <tr>
      <td title="${escapeHtml(it.name)}">${escapeHtml(it.name).slice(0, 160)}</td>
      <td>${fmtMoney(it.spend)}</td>
      <td>${fmtMoney(it.sales)}</td>
      <td>${fmtInt(it.orders)}</td>
      <td>${fmtInt(it.impr)}</td>
      <td>${fmtInt(it.clicks)}</td>
      <td>${fmtPct(it.ctr)}</td>
      <td>${fmtMoney(it.cpc)}</td>
      <td>${fmtPct(it.cvr)}</td>
      <td style="${it.acos > 0.4 ? 'color:#b42318;' : ''}">${fmtPct(it.acos)}</td>
      <td>${it.roas.toFixed(2)}</td>
    </tr>
  `).join("");
};

const buildActionLists = () => {
  const rankBy = $("rankBy").value, keyFn = getRankKey();
  const allItems = [...groupBy(VIEW, keyFn).entries()].map(([name, list]) => ({ name, ...sumMetrics(list) }));
  let bidCandidates = [], negCandidates = [];
  for (const base of allItems) {
    const type = detectRowType(base.name, rankBy);
    const {bid, suggest} = decideBidUp(base);
    if (bid && (type === "keyword" || type === "asin")) bidCandidates.push({ ...base, type, suggest });
    const {action} = decideAction(base, rankBy);
    if (action === "NEGATE" && (type === "keyword" || type === "asin")) negCandidates.push({ ...base, type });
  }
  const filterAndSort = (items) => {
    let filtered = actionTypeFilter === "all" ? items : items.filter(x => x.type === actionTypeFilter);
    return filtered.sort((a,b)=> (b.spend||0) - (a.spend||0)).slice(0, clamp(safeNum($("rankTopN").value) || 30, 5, 500));
  };
  BID_ROWS = filterAndSort(bidCandidates);
  NEG_ROWS = filterAndSort(negCandidates);
};

const renderActionLists = () => {
  buildActionLists();
  const renderTable = (tableId, rows, getRowHtml) => {
    $(tableId).querySelector("tbody").innerHTML = rows.map(getRowHtml).join("");
  };
  renderTable("bidUpTable", BID_ROWS, it => `
    <tr>
      <td><span class="pill">${it.type.toUpperCase()}</span></td>
      <td title="${escapeHtml(it.name)}">${escapeHtml(it.name).slice(0, 140)}</td>
      <td>${fmtMoney(it.spend)}</td>
      <td>${fmtInt(it.orders)}</td>
      <td>${(it.roas ?? 0).toFixed(2)}</td>
      </tr>
  `);
  renderTable("negListTable", NEG_ROWS, it => `
    <tr>
      <td><span class="pill">${it.type.toUpperCase()}</span></td>
      <td title="${escapeHtml(it.name)}">${escapeHtml(it.name).slice(0, 140)}</td>
      <td>${fmtMoney(it.spend)}</td>
      <td>${fmtInt(it.orders)}</td>
      <td>${(it.roas ?? 0).toFixed(2)}</td>
    </tr>
  `);
};

/** =========================
 * Apply Filters
 * ========================= */
const applyFilters = (initial=false) => {
  if (!ALL.length) {
    setSubtitle("æœªå¯¼å…¥æ•°æ®ã€‚è¯·å¯¼å…¥åŒç±»æŠ¥è¡¨ï¼ˆæ”¯æŒå¤šæ–‡ä»¶ï¼‰ã€‚");
    $("kpiGrid").innerHTML = "";
    if (trendChart) { trendChart.destroy(); trendChart = null; }
    $("rankTable").querySelector("tbody").innerHTML = "";
    renderActionLists();
    renderWordFreq();
    renderLongTailMining();
    renderWeekdayAnalysis();
    renderCPCDistribution();
    renderLengthAnalysis();
    
    // NEW Features
    renderMatchTypeAnalysis();
    // [Removed] renderBudgetHealth();
    renderConflictAnalysis();
    return;
  }

  const filters = {
    dateStart: $("dateStart").value, dateEnd: $("dateEnd").value,
    filterSource: $("filterSource").value, filterPortfolio: $("filterPortfolio").value,
    filterCampaign: $("filterCampaign").value, filterAdGroup: $("filterAdGroup").value,
    filterTargeting: $("filterTargeting").value, filterMatchType: $("filterMatchType").value,
    filterAdType: $("filterAdType").value, 
    filterSearchTerm: $("filterSearchTerm").value.trim(),
    filterSearchExact: $("filterSearchExact").checked 
  };

  VIEW = ALL.filter(r => {
    // åŸºç¡€ç­›é€‰
    if (!withinDate(r, filters.dateStart, filters.dateEnd)) return false;
    if (filters.filterSource && r.sourceFile !== filters.filterSource) return false;
    if (filters.filterPortfolio && r.portfolio !== filters.filterPortfolio) return false;
    if (filters.filterCampaign && r.campaign !== filters.filterCampaign) return false;
    if (filters.filterAdGroup && r.adGroup !== filters.filterAdGroup) return false;
    if (filters.filterTargeting && r.targeting !== filters.filterTargeting) return false;
    if (filters.filterMatchType && r.matchType !== filters.filterMatchType) return false;

    // [ä¼˜åŒ–] å¹¿å‘Šç±»å‹ç­›é€‰
    if (filters.filterAdType) {
        // åˆ¤æ–­æ˜¯å¦ä¸ºæ‰‹åŠ¨å¹¿å‘Š (Broad, Phrase, Exact, Product, Targeting)
        // æ¶µç›–äº†å¸¸è§çš„ Keyword Targeting å’Œ Product Targeting (PAT) åœºæ™¯
        const lowerMatch = (r.matchType || "").toLowerCase();
        const isManual = ["broad", "phrase", "exact"].includes(lowerMatch) || lowerMatch.includes("product") || lowerMatch.includes("targeting");
        
        if (filters.filterAdType === "manual" && !isManual) return false;
        if (filters.filterAdType === "auto" && isManual) return false;
    }

    // æœç´¢è¯ç­›é€‰
    if (!includesSearch(r, filters.filterSearchTerm, filters.filterSearchExact)) return false;

    return true;
  });

  const total = sumMetrics(VIEW);
  setSubtitle(`å·²å¯¼å…¥ ${importedFiles.length} ä¸ªæ–‡ä»¶ï¼›ALL=${ALL.length.toLocaleString()} è¡Œï¼›å½“å‰è§†å›¾=${VIEW.length.toLocaleString()} è¡Œï¼›æ—¥æœŸèŒƒå›´ ${filters.dateStart} â†’ ${filters.dateEnd}`);

  renderKPIs(total);
  renderTrend(VIEW);
  renderRankTable();
  renderActionLists();
  renderWordFreq();
  renderLongTailMining(); 
  renderWeekdayAnalysis(); 
  renderCPCDistribution(); 
  renderAutoManual();
  renderLengthAnalysis();
  
  renderMatchTypeAnalysis();
  renderConflictAnalysis(); 

  if (initial) {
    document.querySelectorAll(".chipBtn").forEach(b => b.classList.remove("active"));
    document.querySelector('.chipBtn[data-range="all"]')?.classList.add("active");
  }
};
const autoApply = debounce(applyFilters, 200);

/** =========================
 * Quick Range
 * ========================= */
const applyQuickRange = (type) => {
  if (!ALL.length) return;
  const dates = ALL.map(r=>r.date).filter(Boolean).sort();
  const [minD, maxD] = [dates[0], dates[dates.length-1]];
  const max = new Date(maxD);
  let start = new Date(max);
  const rangeMap = {
    yesterday: () => start.setDate(start.getDate()-1),
    "7d": () => start.setDate(start.getDate()-6),
    "30d": () => start.setDate(start.getDate()-29),
    "mtd": () => start.setDate(1),
    "all": () => { $("dateStart").value = minD; $("dateEnd").value = maxD; return; }
  };
  rangeMap[type]();
  const isoStart = toISODate(start);
  $("dateStart").value = isoStart < minD ? minD : isoStart;
  $("dateEnd").value = maxD;
};

/** =========================
 * Events
 * ========================= */
$("fileInput").addEventListener("change", async (e)=>{
  const files = Array.from(e.target.files || []);
  if (files.length) { log("æ–‡ä»¶é€‰æ‹©äº‹ä»¶è§¦å‘ï¼ˆchangeï¼‰"); await importMultipleFiles(files); e.target.value = ""; }
});

const filterIds = [
  "dateStart","dateEnd","filterSource","filterPortfolio","filterCampaign","filterAdGroup","filterTargeting","filterMatchType",
  "rankBy","rankTopN","ruleSpendNeg","ruleClicksNeg","ruleRoasNeg","ruleRoasKeep","ruleOrdersKeep","ruleRoasMigrateMin",
  "exportScope","exportNegMatch","bidSpend","bidOrders","bidRoas","bidIntensity",
  "wfMinFreq","wfMinSpend",
  "ltMinWords","ltMinOrders","ltMinRoas",
  "filterSearchExact",
  "filterAdType" 
];
filterIds.forEach(id => $(id)?.addEventListener("change", autoApply));
$("filterSearchTerm").addEventListener("input", debounce(applyFilters, 280));

$("btnReset").addEventListener("click", () => {
  ["filterSource","filterPortfolio","filterCampaign","filterAdGroup","filterTargeting","filterMatchType","filterSearchTerm", "filterAdType"].forEach(id => ($(id).value = ""));
  $("rankBy").value = "searchTerm"; rankSort = { key:"spend", dir:"desc" };
  rankTypeFilter = "all"; document.querySelectorAll('.seg[aria-label="Type Filter"] .segBtn').forEach(b=>b.classList.toggle("active", b.dataset.type === "all"));
  actionTypeFilter = "all"; document.querySelectorAll('.seg[aria-label="Action Type Filter"] .segBtn').forEach(b=>b.classList.toggle("active", b.dataset.act === "all"));
  WF_MODE = "token";
  document.querySelectorAll('.seg[aria-label="Word Frequency Mode"] .segBtn').forEach(b=>b.classList.toggle("active", b.dataset.wf === "token"));
  $("wfMinFreq").value = 3; $("wfMinSpend").value = 10;
  wfSort = { key: "spend", dir: "desc" };
  // Reset Long Tail
  $("ltMinWords").value = 3; $("ltMinOrders").value = 2; $("ltMinRoas").value = 2.0;
  // Reset Checkbox
  $("filterSearchExact").checked = false;

  populateDropdowns(); applyFilters(); log("å·²é‡ç½®ç­›é€‰", "good");
});

$("btnClearAll").addEventListener("click", () => {
  ALL = []; VIEW = []; importedFiles = [];
  renderFileList(); populateDropdowns(); applyFilters(true); clearLog(); log("å·²æ¸…ç©ºå…¨éƒ¨æ•°æ®", "warn");
});

document.querySelectorAll(".chipBtn").forEach(btn => btn.addEventListener("click", () => {
  document.querySelectorAll(".chipBtn").forEach(b => b.classList.remove("active"));
  btn.classList.add("active"); applyQuickRange(btn.dataset.range); applyFilters();
}));

$("rankTable").querySelectorAll("thead th").forEach(th => th.addEventListener("click", () => {
  const key = th.dataset.sort;
  if (!key) return;
  rankSort = (rankSort.key === key) ? {key, dir: (rankSort.dir === "desc" ? "asc" : "desc")} : {key, dir:"desc"};
  renderRankTable(); renderActionLists(); renderWordFreq();
}));

$("wfTable").querySelectorAll("thead th").forEach(th => th.addEventListener("click", () => {
  const key = th.dataset.sort;
  if(!key) return;
  wfSort = (wfSort.key === key) ? {key, dir: (wfSort.dir === "desc" ? "asc" : "desc")} : {key, dir:"desc"};
  renderWordFreq();
}));

const setTypeFilter = (t) => {
  rankTypeFilter = t;
  document.querySelectorAll('.seg[aria-label="Type Filter"] .segBtn').forEach(b => b.classList.toggle("active", b.dataset.type === t));
  renderRankTable(); renderActionLists(); renderWordFreq();
};
const setActionTypeFilter = (t) => {
  actionTypeFilter = t;
  document.querySelectorAll('.seg[aria-label="Action Type Filter"] .segBtn').forEach(b => b.classList.toggle("active", b.dataset.act === t));
  renderActionLists(); renderWordFreq();
};

document.addEventListener("click", (e) => {
  const btn = e.target.closest(".segBtn");
  if (!btn) return;
  if (btn.dataset.type) setTypeFilter(btn.dataset.type);
  if (btn.dataset.act) setActionTypeFilter(btn.dataset.act);
  if (btn.dataset.wf) {
    WF_MODE = btn.dataset.wf;
    document.querySelectorAll('.seg[aria-label="Word Frequency Mode"] .segBtn').forEach(b => b.classList.toggle("active", b.dataset.wf === WF_MODE));
    renderWordFreq();
  }
});

$("wfTable").addEventListener("click", (e)=>{
  const tr = e.target.closest("tr");
  if (!tr || !tr.dataset.word) return;
  $("filterSearchTerm").value = tr.dataset.word;
  applyFilters();
});

$("btnExportNeg").addEventListener("click", exportNegativesCSV);
$("btnExportBidUp").addEventListener("click", exportBidUpCSV);
$("btnExportLongTail").addEventListener("click", exportLongTailCSV);
// NEW: Bind Export Rank Button
$("btnExportRank").addEventListener("click", exportRankCSV);

$("btnRuleReset").addEventListener("click", () => {
  $("ruleSpendNeg").value = 30; $("ruleClicksNeg").value = 20; $("ruleRoasNeg").value = 1.5;
  $("ruleRoasKeep").value = 3; $("ruleOrdersKeep").value = 2; $("ruleRoasMigrateMin").value = 2;
  log("å·²é‡ç½®è§„åˆ™ä¸ºé»˜è®¤å€¼", "good"); applyFilters();
});

$("btnCheck").addEventListener("click", () => { 
  log("å¼€å§‹ä¾èµ–è‡ªæ£€â€¦"); 
  if(libsCheck()) alert("æ‰€æœ‰ä¾èµ–åº“åŠ è½½æ­£å¸¸ï¼");
  else alert("ä¾èµ–åº“ç¼ºå¤±ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æ§åˆ¶å°æ—¥å¿—ã€‚");
});

// ========================
// Dark Mode Logic (Optimized)
// ========================
const toggleTheme = () => {
  const isDark = document.documentElement.getAttribute("data-theme") === "dark";
  const newTheme = isDark ? "light" : "dark";
  document.documentElement.setAttribute("data-theme", newTheme);
  localStorage.setItem("theme", newTheme);
  
  // [ä¼˜åŒ–] åˆ‡æ¢ä¸»é¢˜æ—¶ï¼Œé‡ç»˜å›¾è¡¨ä»¥é€‚é…ç½‘æ ¼çº¿é¢œè‰²
  if (trendChart && VIEW.length) renderTrend(VIEW);
};

$("btnTheme").addEventListener("click", toggleTheme);


/** =========================
 * Demo
 * ========================= */
$("btnDemo").addEventListener("click", () => {
  clearLog(); libsCheck();
  const mkDemoData = (file, offset) => {
    const base = new Date(), terms = [
      "blue light reading glasses 2.0", "2.0 magnification readers for women", "cat eye readers 1.5",
      "spring hinge reading glasses 2.5", "progressive readers", "anti glare computer glasses 2.0",
      "reading glasses men 2.5", "women cat-eye blue light readers 2.0", "cheap readers 3.0", "b07ybhgt31"
    ];
    // FORCE CONFLICT DATA: Ensure "blue light reading glasses 2.0" appears in multiple different groups
    const asins = ["B07YBHGT31","B0ABCDE1234","B0ZZZZZ9999","B0QWERTY123"];
    return Array.from({length:30}).map((_,i) => {
      const d = new Date(base); 
      d.setDate(d.getDate() - (13-i) - offset);
      
      let st = terms[Math.floor(Math.random()*terms.length)];
      // Inject deliberate conflict
      if(i % 5 === 0) st = "blue light reading glasses 2.0"; 

      const spend = Math.random()*80 + 10, clicks = Math.round(Math.random()*120);
      const impr = clicks* (Math.round(Math.random()*30)+10);
      const orders = Math.random()<0.35 ? 0 : Math.round(Math.random()*4);
      const sales = orders * (Math.random()*40 + 18);
      
      const targeting = Math.random()<0.5 ? "keyword" : `asin=${asins[Math.floor(Math.random()*asins.length)]}`;
      
      // Randomize Campaign/AdGroup to create conflicts
      const campaign = Math.random()<0.5 ? "Campaign Manual" : (Math.random()<0.5?"Campaign Auto":"Campaign Seasonal");
      const adGroup = Math.random()<0.5 ? "AdGroup Core" : "AdGroup Test";

      return {
        sourceFile:file, date:toISODate(d),
        portfolio:"Portfolio A",
        campaign,
        adGroup,
        targeting, matchType:(Math.random()<0.4?"broad":(Math.random()<0.6?"phrase":"exact")),
        searchTerm:st, searchTermRoot:searchTermToRoot(st),
        impr, clicks, spend, sales, orders,
        ctr:impr>0?clicks/impr:0, cpc:clicks>0?spend/clicks:0, cvr:clicks>0?orders/clicks:0,
        acos:sales>0?spend/sales:0, roas:spend>0?sales/spend:0,
      };
    });
  };

  if ($("mergeMode").value === "replace") { ALL = []; importedFiles = []; rootCache.clear(); }
  const a = mkDemoData("demo_A.xlsx", 0), b = mkDemoData("demo_B.xlsx", 10);
  ALL = ALL.concat(a,b);
  importedFiles.push({name:"demo_A.xlsx", rows:a.length}, {name:"demo_B.xlsx", rows:b.length});

  if ($("dedupeMode").value === "on") { const before = ALL.length; ALL = dedupeRows(ALL); log(`æ¼”ç¤ºæ•°æ®å»é‡ï¼š${before} â†’ ${ALL.length}`, "good"); }
  renderFileList(); populateDropdowns();
  const dates = ALL.map(r=>r.date).sort();
  $("dateStart").value = dates[0]; $("dateEnd").value = dates[dates.length-1];
  applyFilters(true);
  log("å·²è½½å…¥æ¼”ç¤ºæ•°æ®ï¼ˆå«å†²çªæ£€æµ‹æ¼”ç¤ºï¼‰", "good");
});

/** =========================
 * Boot
 * ========================= */
renderFileList();
populateDropdowns();
applyFilters(true);
</script>
</body>
</html>
